import { NzTreeNode } from 'ng-zorro-antd/tree';
import { IdGenerater } from 'epsgis';
import { isArray } from 'lodash';
import { newXbsjFolderNode, newXbsjLayerNode } from '../models/layer-xbsj-func';
export class SceneTreeUtils {
    static SceneTree2NgZorroTree(root) {
        if (!root || !root.children || root.children.length <= 0) {
            return root;
        }
        let rootNode = null;
        if (root.title && root.title !== "未命名") {
            rootNode = new NzTreeNode({
                title: root.title,
                expanded: root.expand === true,
                key: root.guid || root.xbsjGuid || IdGenerater.newGuid(),
                origin: root,
                isLeaf: false,
                parentNode: null
            });
            rootNode.level = -1;
        }
        const _layerNodes = [];
        if (rootNode) {
            rootNode.children.push(...SceneTreeUtils.convertChildren(root.children, rootNode));
            _layerNodes.push(rootNode);
        }
        else {
            _layerNodes.push(...SceneTreeUtils.convertChildren(root.children, rootNode));
        }
        return _layerNodes;
    }
    static convertChildren(children, parentNode) {
        if (!children || children.length <= 0) {
            return [];
        }
        const _layerNodes = [];
        children.forEach(item => {
            let node = null;
            if (item.children) {
                node = new NzTreeNode({
                    level: parentNode.level + 1,
                    title: item.title,
                    isExpanded: item.expand === true,
                    key: item.guid || item.xbsjGuid || IdGenerater.newGuid(),
                    origin: item,
                    isLeaf: false,
                    parentNode: parentNode
                });
                node.parentNode = parentNode;
                node.level = parentNode.level + 1;
                node.isExpanded = item.expand ? true : false;
                if (item.children.length >= 1) {
                    node.children.push(...SceneTreeUtils.convertChildren(item.children, node));
                }
                let checkList = [];
                node.children.forEach((child) => {
                    if (child.children && child.children.length > 0) {
                        checkList.push(child.isChecked);
                    }
                    else {
                        if (child.origin.origin.show) {
                            checkList.push(true);
                        }
                        else {
                            checkList.push(false);
                        }
                    }
                });
                if (SceneTreeUtils.isAllEqual(checkList) && checkList[0] == true) {
                    node.isChecked = true;
                }
                else if (SceneTreeUtils.isAllEqual(checkList) && checkList[0] == false) {
                    node.isChecked = false;
                }
                else if (!SceneTreeUtils.isAllEqual(checkList)) {
                    node.isHalfChecked = true;
                }
                _layerNodes.push(node);
            }
            else {
                let childNode = SceneTreeUtils.convertCzmObject(item.czmObject, parentNode);
                childNode.parentNode = childNode.origin.parentNode;
                childNode.level = childNode.parentNode.level + 1;
                _layerNodes.push(childNode);
            }
        });
        return _layerNodes;
    }
    static isAllEqual(array) {
        if (array.length > 0) {
            return !array.some(function (value, index) {
                return value !== array[0];
            });
        }
        else {
            return true;
        }
    }
    static convertCzmObject(czmObject, parentNode) {
        if (!czmObject) {
            return null;
        }
        return new NzTreeNode({
            title: czmObject.name,
            key: czmObject.guid || czmObject.xbsjGuid || IdGenerater.newGuid(),
            origin: czmObject,
            isLeaf: true,
            checked: czmObject.show,
            parentNode: parentNode
        });
    }
    static GetXbsjCzmObject(node) {
        return node && node.origin && node.origin.origin;
    }
    static loadLayers(layerConfig) {
        if (!layerConfig) {
            return null;
        }
        if (!layerConfig.basemaps && !layerConfig.layers) {
            return null;
        }
        const _layerNodes = [];
        const _layerlist = [
            {
                "title": "basemap",
                "ref": "basemap",
                "children": [],
            },
            {
                "title": "layerlist",
                "ref": "layerlist",
                "children": [],
            },
            {
                "tilte": "pin",
                "ref": "pin",
                "children": []
            }
        ];
        if (typeof layerConfig.basemaps === "object" && isArray(layerConfig.basemaps)) {
            layerConfig.basemaps.forEach((item) => {
                _layerlist[0].children.push(SceneTreeUtils.loadLayerNode(item));
            });
        }
        if (typeof layerConfig.layers === "object" && isArray(layerConfig.layers)) {
            layerConfig.layers.forEach((item) => {
                _layerlist[1].children.push(SceneTreeUtils.loadLayerNode(item));
            });
        }
        return { children: _layerlist };
    }
    static loadLayerNode(item) {
        if (isArray(item.children)) {
            const node = newXbsjFolderNode(item.title);
            if (item.children && item.children.length >= 1) {
                item.children.forEach((child) => {
                    node.children.push(SceneTreeUtils.loadLayerNode(child));
                });
            }
            node.expand = item.expand;
            return node;
        }
        else if (item.url || item.layer) {
            const node = newXbsjLayerNode(item.type, item.title, item.url);
            node.czmObject.xbsjGuid = item.guid;
            node.czmObject.show = item.show ? true : false;
            node.ref = item.ref;
            if (node.czmObject.hasOwnProperty("xbsjImageryProvider")) {
                if (item.srcCoordType) {
                    node.czmObject.xbsjImageryProvider.XbsjImageryProvider.srcCoordType = item.srcCoordType;
                }
                if (item.dstCoordType) {
                    node.czmObject.xbsjImageryProvider.XbsjImageryProvider.dstCoordType = item.dstCoordType;
                }
            }
            else if (node.czmObject.hasOwnProperty("xbsjTerrainProvider")) {
            }
            else if (node.hasOwnProperty("url")) {
            }
            if (item.extendOptions) {
                node.czmObject = Object.assign(node.czmObject, item.extendOptions);
                if (item.extendOptions.rectangle) {
                    let rect = [];
                    node.czmObject.rectangle.forEach(item => {
                        rect.push(item / 180 * Math.PI);
                    });
                    node.czmObject.rectangle = rect;
                }
            }
            return node;
        }
        return null;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NlbmVUcmVlLXV0aWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvZXBzcGxhbmV0L3V0aWxzL3NjZW5lVHJlZS11dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFDaEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLFFBQVEsQ0FBQztBQUNyQyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBRWpDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBTWhGLE1BQU0sT0FBTyxjQUFjO0lBS3ZCLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQyxJQUFTO1FBQ2xDLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxJQUFJLENBQUMsRUFBRTtZQUN0RCxPQUFPLElBQUksQ0FBQztTQUNmO1FBQ0QsSUFBSSxRQUFRLEdBQWUsSUFBSSxDQUFDO1FBQ2hDLElBQUksSUFBSSxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsS0FBSyxLQUFLLEtBQUssRUFBRTtZQUNwQyxRQUFRLEdBQUcsSUFBSSxVQUFVLENBQUM7Z0JBQ3RCLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSztnQkFDakIsUUFBUSxFQUFFLElBQUksQ0FBQyxNQUFNLEtBQUssSUFBSTtnQkFDOUIsR0FBRyxFQUFFLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLFFBQVEsSUFBSSxXQUFXLENBQUMsT0FBTyxFQUFFO2dCQUN4RCxNQUFNLEVBQUUsSUFBSTtnQkFDWixNQUFNLEVBQUUsS0FBSztnQkFDYixVQUFVLEVBQUUsSUFBSTthQUNuQixDQUFDLENBQUM7WUFDSCxRQUFRLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFBO1NBR3RCO1FBQ0QsTUFBTSxXQUFXLEdBQXNCLEVBQUUsQ0FBQztRQUMxQyxJQUFJLFFBQVEsRUFBRTtZQUNWLFFBQVEsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsY0FBYyxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUM7WUFDbkYsV0FBVyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUM5QjthQUFNO1lBQ0gsV0FBVyxDQUFDLElBQUksQ0FBQyxHQUFHLGNBQWMsQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDO1NBQ2hGO1FBRUQsT0FBTyxXQUFXLENBQUM7SUFDdkIsQ0FBQztJQU1PLE1BQU0sQ0FBQyxlQUFlLENBQUMsUUFBb0IsRUFBRSxVQUFlO1FBQ2hFLElBQUksQ0FBQyxRQUFRLElBQUksUUFBUSxDQUFDLE1BQU0sSUFBSSxDQUFDLEVBQUU7WUFDbkMsT0FBTyxFQUFFLENBQUM7U0FDYjtRQUNELE1BQU0sV0FBVyxHQUFzQixFQUFFLENBQUM7UUFDMUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUVwQixJQUFJLElBQUksR0FBZSxJQUFJLENBQUM7WUFDNUIsSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFO2dCQUNmLElBQUksR0FBRyxJQUFJLFVBQVUsQ0FBQztvQkFDbEIsS0FBSyxFQUFFLFVBQVUsQ0FBQyxLQUFLLEdBQUcsQ0FBQztvQkFDM0IsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLO29CQUNqQixVQUFVLEVBQUUsSUFBSSxDQUFDLE1BQU0sS0FBSyxJQUFJO29CQUdoQyxHQUFHLEVBQUUsSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsUUFBUSxJQUFJLFdBQVcsQ0FBQyxPQUFPLEVBQUU7b0JBQ3hELE1BQU0sRUFBRSxJQUFJO29CQUNaLE1BQU0sRUFBRSxLQUFLO29CQUNiLFVBQVUsRUFBRSxVQUFVO2lCQUN6QixDQUFDLENBQUM7Z0JBQ0gsSUFBSSxDQUFDLFVBQVUsR0FBRyxVQUFVLENBQUM7Z0JBQzdCLElBQUksQ0FBQyxLQUFLLEdBQUcsVUFBVSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUM7Z0JBRWxDLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7Z0JBQzdDLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLElBQUksQ0FBQyxFQUFFO29CQUMzQixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLGNBQWMsQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO2lCQUM5RTtnQkFFRCxJQUFJLFNBQVMsR0FBRyxFQUFFLENBQUE7Z0JBQ2xCLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBVSxFQUFFLEVBQUU7b0JBQ2pDLElBQUksS0FBSyxDQUFDLFFBQVEsSUFBSSxLQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7d0JBQzdDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFBO3FCQUNsQzt5QkFBTTt3QkFDSCxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRTs0QkFDMUIsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTt5QkFDdkI7NkJBQU07NEJBQ0gsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQTt5QkFDeEI7cUJBQ0o7Z0JBQ0wsQ0FBQyxDQUFDLENBQUE7Z0JBQ0YsSUFBSSxjQUFjLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxJQUFJLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLEVBQUU7b0JBQzlELElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFBO2lCQUN4QjtxQkFBTSxJQUFJLGNBQWMsQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLElBQUksU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssRUFBRTtvQkFDdEUsSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUE7aUJBQ3pCO3FCQUFNLElBQUksQ0FBQyxjQUFjLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxFQUFFO29CQUM5QyxJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQTtpQkFDNUI7Z0JBR0QsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUMxQjtpQkFBTTtnQkFFSCxJQUFJLFNBQVMsR0FBRyxjQUFjLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxVQUFVLENBQUMsQ0FBQTtnQkFDM0UsU0FBUyxDQUFDLFVBQVUsR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQztnQkFDbkQsU0FBUyxDQUFDLEtBQUssR0FBRyxTQUFTLENBQUMsVUFBVSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUE7Z0JBQ2hELFdBQVcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7YUFFL0I7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sV0FBVyxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxNQUFNLENBQUMsVUFBVSxDQUFDLEtBQUs7UUFDbkIsSUFBSSxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUNsQixPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxVQUFVLEtBQUssRUFBRSxLQUFLO2dCQUNyQyxPQUFPLEtBQUssS0FBSyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDOUIsQ0FBQyxDQUFDLENBQUM7U0FDTjthQUFNO1lBQ0gsT0FBTyxJQUFJLENBQUM7U0FDZjtJQUNMLENBQUM7SUFLTyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsU0FBYyxFQUFFLFVBQXNCO1FBQ2xFLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDWixPQUFPLElBQUksQ0FBQztTQUNmO1FBQ0QsT0FBTyxJQUFJLFVBQVUsQ0FBQztZQUNsQixLQUFLLEVBQUUsU0FBUyxDQUFDLElBQUk7WUFDckIsR0FBRyxFQUFFLFNBQVMsQ0FBQyxJQUFJLElBQUksU0FBUyxDQUFDLFFBQVEsSUFBSSxXQUFXLENBQUMsT0FBTyxFQUFFO1lBQ2xFLE1BQU0sRUFBRSxTQUFTO1lBQ2pCLE1BQU0sRUFBRSxJQUFJO1lBRVosT0FBTyxFQUFFLFNBQVMsQ0FBQyxJQUFJO1lBQ3ZCLFVBQVUsRUFBRSxVQUFVO1NBQ3pCLENBQUMsQ0FBQztJQUNQLENBQUM7SUFJRCxNQUFNLENBQUMsZ0JBQWdCLENBQUMsSUFBZ0I7UUFFcEMsT0FBTyxJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQztJQUNyRCxDQUFDO0lBUUQsTUFBTSxDQUFDLFVBQVUsQ0FBQyxXQUFnQjtRQUM5QixJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ2QsT0FBTyxJQUFJLENBQUM7U0FDZjtRQUNELElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRTtZQUM5QyxPQUFPLElBQUksQ0FBQztTQUNmO1FBQ0QsTUFBTSxXQUFXLEdBQWUsRUFBRSxDQUFDO1FBRW5DLE1BQU0sVUFBVSxHQUFHO1lBQ2Y7Z0JBQ0ksT0FBTyxFQUFFLFNBQVM7Z0JBQ2xCLEtBQUssRUFBRSxTQUFTO2dCQUNoQixVQUFVLEVBQUUsRUFBRTthQUNqQjtZQUNEO2dCQUNJLE9BQU8sRUFBRSxXQUFXO2dCQUNwQixLQUFLLEVBQUUsV0FBVztnQkFDbEIsVUFBVSxFQUFFLEVBQUU7YUFDakI7WUFDRDtnQkFDSSxPQUFPLEVBQUUsS0FBSztnQkFDZCxLQUFLLEVBQUUsS0FBSztnQkFDWixVQUFVLEVBQUUsRUFBRTthQUNqQjtTQUNKLENBQUE7UUFHRCxJQUFJLE9BQU8sV0FBVyxDQUFDLFFBQVEsS0FBSyxRQUFRLElBQUksT0FBTyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsRUFBRTtZQUMzRSxXQUFXLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQStCLEVBQUUsRUFBRTtnQkFDN0QsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3BFLENBQUMsQ0FBQyxDQUFDO1NBQ047UUFFRCxJQUFJLE9BQU8sV0FBVyxDQUFDLE1BQU0sS0FBSyxRQUFRLElBQUksT0FBTyxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsRUFBRTtZQUN2RSxXQUFXLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQStCLEVBQUUsRUFBRTtnQkFDM0QsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3BFLENBQUMsQ0FBQyxDQUFDO1NBQ047UUFDRCxPQUFPLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxDQUFDO0lBQ3BDLENBQUM7SUFJRCxNQUFNLENBQUMsYUFBYSxDQUFDLElBQStCO1FBQ2hELElBQUksT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRTtZQUV4QixNQUFNLElBQUksR0FBaUIsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3pELElBQUksSUFBSSxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sSUFBSSxDQUFDLEVBQUU7Z0JBQzVDLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBZ0MsRUFBRSxFQUFFO29CQUN2RCxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUE7Z0JBQzNELENBQUMsQ0FBQyxDQUFBO2FBQ0w7WUFDRCxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7WUFDMUIsT0FBTyxJQUFJLENBQUM7U0FDZjthQUFNLElBQUksSUFBSSxDQUFDLEdBQUcsSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO1lBSS9CLE1BQU0sSUFBSSxHQUFtQixnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQy9FLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7WUFDcEMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7WUFDL0MsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDO1lBQ3BCLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMscUJBQXFCLENBQUMsRUFBRTtnQkFFdEQsSUFBSSxJQUFJLENBQUMsWUFBWSxFQUFFO29CQUVuQixJQUFJLENBQUMsU0FBUyxDQUFDLG1CQUFtQixDQUFDLG1CQUFtQixDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDO2lCQUMzRjtnQkFDRCxJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUU7b0JBRW5CLElBQUksQ0FBQyxTQUFTLENBQUMsbUJBQW1CLENBQUMsbUJBQW1CLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUM7aUJBQzNGO2FBQ0o7aUJBQU0sSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FBQyxxQkFBcUIsQ0FBQyxFQUFFO2FBRWhFO2lCQUNJLElBQUksSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsRUFBRTthQUdwQztZQUNELElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRTtnQkFFcEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDO2dCQUNuRSxJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxFQUFFO29CQUU5QixJQUFJLElBQUksR0FBRyxFQUFFLENBQUE7b0JBQ2IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFO3dCQUNwQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFBO29CQUNuQyxDQUFDLENBQUMsQ0FBQTtvQkFDRixJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUE7aUJBQ2xDO2FBQ0o7WUFDRCxPQUFPLElBQUksQ0FBQztTQUNmO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTnpUcmVlTm9kZSB9IGZyb20gJ25nLXpvcnJvLWFudGQvdHJlZSc7XG5pbXBvcnQgeyBJZEdlbmVyYXRlciB9IGZyb20gJ2Vwc2dpcyc7XG5pbXBvcnQgeyBpc0FycmF5IH0gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IElMYXllck5vZGUsIElMYXllckZvbGRlciB9IGZyb20gJy4uL21vZGVscy9sYXllci1jb25maWcnO1xuaW1wb3J0IHsgbmV3WGJzakZvbGRlck5vZGUsIG5ld1hic2pMYXllck5vZGUgfSBmcm9tICcuLi9tb2RlbHMvbGF5ZXIteGJzai1mdW5jJztcbmltcG9ydCB7IElYYnNqQ3ptT2JqZWN0IH0gZnJvbSAnLi4vbW9kZWxzL2xheWVyLXhic2onO1xuXG4vKipcbiAqICDlnLrmma/moJHluK7liqnnsbsgY3JlYXRlIGJ5IHJ1aXJcbiAqL1xuZXhwb3J0IGNsYXNzIFNjZW5lVHJlZVV0aWxzIHtcbiAgICAvKipcbiAgICAgKiDlsIblnLrmma/moJHmlbDmja7ovazkuLpuZ1pvcnJv57uT5p6E55qE5qCR5pWw5o2uXG4gICAgICogQHBhcmFtIHJvb3QgdGhpcy52aWV3LnNjZW5lVHJlZS5yb290XG4gICAgICovXG4gICAgc3RhdGljIFNjZW5lVHJlZTJOZ1pvcnJvVHJlZShyb290OiBhbnkpOiBBcnJheTxOelRyZWVOb2RlPiB7XG4gICAgICAgIGlmICghcm9vdCB8fCAhcm9vdC5jaGlsZHJlbiB8fCByb290LmNoaWxkcmVuLmxlbmd0aCA8PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gcm9vdDtcbiAgICAgICAgfVxuICAgICAgICBsZXQgcm9vdE5vZGU6IE56VHJlZU5vZGUgPSBudWxsO1xuICAgICAgICBpZiAocm9vdC50aXRsZSAmJiByb290LnRpdGxlICE9PSBcIuacquWRveWQjVwiKSB7XG4gICAgICAgICAgICByb290Tm9kZSA9IG5ldyBOelRyZWVOb2RlKHtcbiAgICAgICAgICAgICAgICB0aXRsZTogcm9vdC50aXRsZSxcbiAgICAgICAgICAgICAgICBleHBhbmRlZDogcm9vdC5leHBhbmQgPT09IHRydWUsXG4gICAgICAgICAgICAgICAga2V5OiByb290Lmd1aWQgfHwgcm9vdC54YnNqR3VpZCB8fCBJZEdlbmVyYXRlci5uZXdHdWlkKCksXG4gICAgICAgICAgICAgICAgb3JpZ2luOiByb290LFxuICAgICAgICAgICAgICAgIGlzTGVhZjogZmFsc2UsXG4gICAgICAgICAgICAgICAgcGFyZW50Tm9kZTogbnVsbFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICByb290Tm9kZS5sZXZlbCA9IC0xXG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcInJvb3RcIixyb290LHJvb3ROb2RlKVxuICAgICAgICAgICAgLy8gcm9vdE5vZGUuaXNFeHBhbmRlZCA9IHJvb3QuZXhwYW5kID09PSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IF9sYXllck5vZGVzOiBBcnJheTxOelRyZWVOb2RlPiA9IFtdO1xuICAgICAgICBpZiAocm9vdE5vZGUpIHtcbiAgICAgICAgICAgIHJvb3ROb2RlLmNoaWxkcmVuLnB1c2goLi4uU2NlbmVUcmVlVXRpbHMuY29udmVydENoaWxkcmVuKHJvb3QuY2hpbGRyZW4sIHJvb3ROb2RlKSk7XG4gICAgICAgICAgICBfbGF5ZXJOb2Rlcy5wdXNoKHJvb3ROb2RlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIF9sYXllck5vZGVzLnB1c2goLi4uU2NlbmVUcmVlVXRpbHMuY29udmVydENoaWxkcmVuKHJvb3QuY2hpbGRyZW4sIHJvb3ROb2RlKSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gX2xheWVyTm9kZXM7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIFxuICAgICAqIEBwYXJhbSBjaGlsZHJlbiBcbiAgICAgKiBAcGFyYW0gcGFyZW50Tm9kZSBcbiAgICAgKi9cbiAgICBwcml2YXRlIHN0YXRpYyBjb252ZXJ0Q2hpbGRyZW4oY2hpbGRyZW46IEFycmF5PGFueT4sIHBhcmVudE5vZGU6IGFueSk6IEFycmF5PE56VHJlZU5vZGU+IHtcbiAgICAgICAgaWYgKCFjaGlsZHJlbiB8fCBjaGlsZHJlbi5sZW5ndGggPD0gMCkge1xuICAgICAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IF9sYXllck5vZGVzOiBBcnJheTxOelRyZWVOb2RlPiA9IFtdO1xuICAgICAgICBjaGlsZHJlbi5mb3JFYWNoKGl0ZW0gPT4ge1xuXG4gICAgICAgICAgICBsZXQgbm9kZTogTnpUcmVlTm9kZSA9IG51bGw7XG4gICAgICAgICAgICBpZiAoaXRlbS5jaGlsZHJlbikgeyAvLyBpdGVtLnRpdGxlXG4gICAgICAgICAgICAgICAgbm9kZSA9IG5ldyBOelRyZWVOb2RlKHtcbiAgICAgICAgICAgICAgICAgICAgbGV2ZWw6IHBhcmVudE5vZGUubGV2ZWwgKyAxLFxuICAgICAgICAgICAgICAgICAgICB0aXRsZTogaXRlbS50aXRsZSxcbiAgICAgICAgICAgICAgICAgICAgaXNFeHBhbmRlZDogaXRlbS5leHBhbmQgPT09IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIC8vIGlzQ2hlY2tlZDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgLy8gY2hlY2tlZDppdGVtLmlzU2VsZWN0ZWQsXG4gICAgICAgICAgICAgICAgICAgIGtleTogaXRlbS5ndWlkIHx8IGl0ZW0ueGJzakd1aWQgfHwgSWRHZW5lcmF0ZXIubmV3R3VpZCgpLFxuICAgICAgICAgICAgICAgICAgICBvcmlnaW46IGl0ZW0sXG4gICAgICAgICAgICAgICAgICAgIGlzTGVhZjogZmFsc2UsXG4gICAgICAgICAgICAgICAgICAgIHBhcmVudE5vZGU6IHBhcmVudE5vZGVcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICBub2RlLnBhcmVudE5vZGUgPSBwYXJlbnROb2RlO1xuICAgICAgICAgICAgICAgIG5vZGUubGV2ZWwgPSBwYXJlbnROb2RlLmxldmVsICsgMTtcblxuICAgICAgICAgICAgICAgIG5vZGUuaXNFeHBhbmRlZCA9IGl0ZW0uZXhwYW5kID8gdHJ1ZSA6IGZhbHNlO1xuICAgICAgICAgICAgICAgIGlmIChpdGVtLmNoaWxkcmVuLmxlbmd0aCA+PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIG5vZGUuY2hpbGRyZW4ucHVzaCguLi5TY2VuZVRyZWVVdGlscy5jb252ZXJ0Q2hpbGRyZW4oaXRlbS5jaGlsZHJlbiwgbm9kZSkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBub2RlLmlzRXhwYW5kZWQgPSBpdGVtLmV4cGFuZCA9PT0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBsZXQgY2hlY2tMaXN0ID0gW11cbiAgICAgICAgICAgICAgICBub2RlLmNoaWxkcmVuLmZvckVhY2goKGNoaWxkOiBhbnkpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLmNoaWxkcmVuICYmIGNoaWxkLmNoaWxkcmVuLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrTGlzdC5wdXNoKGNoaWxkLmlzQ2hlY2tlZClcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGlsZC5vcmlnaW4ub3JpZ2luLnNob3cpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGVja0xpc3QucHVzaCh0cnVlKVxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGVja0xpc3QucHVzaChmYWxzZSlcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgaWYgKFNjZW5lVHJlZVV0aWxzLmlzQWxsRXF1YWwoY2hlY2tMaXN0KSAmJiBjaGVja0xpc3RbMF0gPT0gdHJ1ZSkge1xuICAgICAgICAgICAgICAgICAgICBub2RlLmlzQ2hlY2tlZCA9IHRydWVcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKFNjZW5lVHJlZVV0aWxzLmlzQWxsRXF1YWwoY2hlY2tMaXN0KSAmJiBjaGVja0xpc3RbMF0gPT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICAgICAgbm9kZS5pc0NoZWNrZWQgPSBmYWxzZVxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoIVNjZW5lVHJlZVV0aWxzLmlzQWxsRXF1YWwoY2hlY2tMaXN0KSkge1xuICAgICAgICAgICAgICAgICAgICBub2RlLmlzSGFsZkNoZWNrZWQgPSB0cnVlXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIG5vZGUuaXNDaGVja2VkID0gdHJ1ZTsvL+WIneWni+m7mOiupOWLvumAieeItuiKgueCuVxuICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGl0ZW0udGl0bGUsaXRlbSlcbiAgICAgICAgICAgICAgICBfbGF5ZXJOb2Rlcy5wdXNoKG5vZGUpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvL+S5i+WJjeWPtuiKgueCueaLv+S4jeWIsHBhcmVudE5vZGUs5by66KGM5LuO5a6D55qEb3JpZ2lu5Lit5Y+W5YiwcGFyZW50Tm9kZSznlKjkuo7lrp7njrDoioLngrnnmoTljZXpgIlcbiAgICAgICAgICAgICAgICBsZXQgY2hpbGROb2RlID0gU2NlbmVUcmVlVXRpbHMuY29udmVydEN6bU9iamVjdChpdGVtLmN6bU9iamVjdCwgcGFyZW50Tm9kZSlcbiAgICAgICAgICAgICAgICBjaGlsZE5vZGUucGFyZW50Tm9kZSA9IGNoaWxkTm9kZS5vcmlnaW4ucGFyZW50Tm9kZTtcbiAgICAgICAgICAgICAgICBjaGlsZE5vZGUubGV2ZWwgPSBjaGlsZE5vZGUucGFyZW50Tm9kZS5sZXZlbCArIDFcbiAgICAgICAgICAgICAgICBfbGF5ZXJOb2Rlcy5wdXNoKGNoaWxkTm9kZSk7XG4gICAgICAgICAgICAgICAgLy8gX2xheWVyTm9kZXMucHVzaChTY2VuZVRyZWVVdGlscy5jb252ZXJ0Q3ptT2JqZWN0KGl0ZW0uY3ptT2JqZWN0LCBwYXJlbnROb2RlKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gX2xheWVyTm9kZXM7XG4gICAgfVxuXG4gICAgc3RhdGljIGlzQWxsRXF1YWwoYXJyYXkpIHtcbiAgICAgICAgaWYgKGFycmF5Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHJldHVybiAhYXJyYXkuc29tZShmdW5jdGlvbiAodmFsdWUsIGluZGV4KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlICE9PSBhcnJheVswXTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgLyoqXG4gICAgICogXG4gICAgICogQHBhcmFtIGN6bU9iamVjdCBcbiAgICAgKi9cbiAgICBwcml2YXRlIHN0YXRpYyBjb252ZXJ0Q3ptT2JqZWN0KGN6bU9iamVjdDogYW55LCBwYXJlbnROb2RlOiBOelRyZWVOb2RlKTogTnpUcmVlTm9kZSB7XG4gICAgICAgIGlmICghY3ptT2JqZWN0KSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbmV3IE56VHJlZU5vZGUoe1xuICAgICAgICAgICAgdGl0bGU6IGN6bU9iamVjdC5uYW1lLFxuICAgICAgICAgICAga2V5OiBjem1PYmplY3QuZ3VpZCB8fCBjem1PYmplY3QueGJzakd1aWQgfHwgSWRHZW5lcmF0ZXIubmV3R3VpZCgpLFxuICAgICAgICAgICAgb3JpZ2luOiBjem1PYmplY3QsXG4gICAgICAgICAgICBpc0xlYWY6IHRydWUsXG4gICAgICAgICAgICAvLyBjaGVja2VkOiBjem1PYmplY3QuaXNTZWxlY3RlZCxcbiAgICAgICAgICAgIGNoZWNrZWQ6IGN6bU9iamVjdC5zaG93LFxuICAgICAgICAgICAgcGFyZW50Tm9kZTogcGFyZW50Tm9kZVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgLyoqXG4gICAgICogXG4gICAgICovXG4gICAgc3RhdGljIEdldFhic2pDem1PYmplY3Qobm9kZTogTnpUcmVlTm9kZSkge1xuICAgICAgICAvLyByZXR1cm4gbm9kZT8ub3JpZ2luPy5vcmlnaW47XG4gICAgICAgIHJldHVybiBub2RlICYmIG5vZGUub3JpZ2luICYmIG5vZGUub3JpZ2luLm9yaWdpbjtcbiAgICB9XG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLyoqXG4gICAgICog5Zu+5bGC5Yqg6L29XG4gICAgICogQHBhcmFtIGxheWVyQ29uZmlnIFxuICAgICAqL1xuICAgIHN0YXRpYyBsb2FkTGF5ZXJzKGxheWVyQ29uZmlnOiBhbnkpIHtcbiAgICAgICAgaWYgKCFsYXllckNvbmZpZykge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFsYXllckNvbmZpZy5iYXNlbWFwcyAmJiAhbGF5ZXJDb25maWcubGF5ZXJzKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBfbGF5ZXJOb2RlczogQXJyYXk8YW55PiA9IFtdO1xuICAgICAgICAvL+WbuuWumuW6leWbvuWSjOWFtuS7luWbvuWxguWIhue7hFxuICAgICAgICBjb25zdCBfbGF5ZXJsaXN0ID0gW1xuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIFwidGl0bGVcIjogXCJiYXNlbWFwXCIsXG4gICAgICAgICAgICAgICAgXCJyZWZcIjogXCJiYXNlbWFwXCIsXG4gICAgICAgICAgICAgICAgXCJjaGlsZHJlblwiOiBbXSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgXCJ0aXRsZVwiOiBcImxheWVybGlzdFwiLFxuICAgICAgICAgICAgICAgIFwicmVmXCI6IFwibGF5ZXJsaXN0XCIsXG4gICAgICAgICAgICAgICAgXCJjaGlsZHJlblwiOiBbXSxcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgXCJ0aWx0ZVwiOiBcInBpblwiLFxuICAgICAgICAgICAgICAgIFwicmVmXCI6IFwicGluXCIsXG4gICAgICAgICAgICAgICAgXCJjaGlsZHJlblwiOiBbXVxuICAgICAgICAgICAgfVxuICAgICAgICBdXG5cbiAgICAgICAgLy/lupXlm75cbiAgICAgICAgaWYgKHR5cGVvZiBsYXllckNvbmZpZy5iYXNlbWFwcyA9PT0gXCJvYmplY3RcIiAmJiBpc0FycmF5KGxheWVyQ29uZmlnLmJhc2VtYXBzKSkge1xuICAgICAgICAgICAgbGF5ZXJDb25maWcuYmFzZW1hcHMuZm9yRWFjaCgoaXRlbTogSUxheWVyTm9kZSB8IElMYXllckZvbGRlcikgPT4ge1xuICAgICAgICAgICAgICAgIF9sYXllcmxpc3RbMF0uY2hpbGRyZW4ucHVzaChTY2VuZVRyZWVVdGlscy5sb2FkTGF5ZXJOb2RlKGl0ZW0pKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIC8v5Zu+5bGCXG4gICAgICAgIGlmICh0eXBlb2YgbGF5ZXJDb25maWcubGF5ZXJzID09PSBcIm9iamVjdFwiICYmIGlzQXJyYXkobGF5ZXJDb25maWcubGF5ZXJzKSkge1xuICAgICAgICAgICAgbGF5ZXJDb25maWcubGF5ZXJzLmZvckVhY2goKGl0ZW06IElMYXllck5vZGUgfCBJTGF5ZXJGb2xkZXIpID0+IHtcbiAgICAgICAgICAgICAgICBfbGF5ZXJsaXN0WzFdLmNoaWxkcmVuLnB1c2goU2NlbmVUcmVlVXRpbHMubG9hZExheWVyTm9kZShpdGVtKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4geyBjaGlsZHJlbjogX2xheWVybGlzdCB9O1xuICAgIH1cbiAgICAvKipcbiAgICAgKiBcbiAgICAgKi9cbiAgICBzdGF0aWMgbG9hZExheWVyTm9kZShpdGVtOiBJTGF5ZXJOb2RlIHwgSUxheWVyRm9sZGVyKSB7XG4gICAgICAgIGlmIChpc0FycmF5KGl0ZW0uY2hpbGRyZW4pKSB7XG4gICAgICAgICAgICAvL+ebruW9lVxuICAgICAgICAgICAgY29uc3Qgbm9kZTogSUxheWVyRm9sZGVyID0gbmV3WGJzakZvbGRlck5vZGUoaXRlbS50aXRsZSk7XG4gICAgICAgICAgICBpZiAoaXRlbS5jaGlsZHJlbiAmJiBpdGVtLmNoaWxkcmVuLmxlbmd0aCA+PSAxKSB7XG4gICAgICAgICAgICAgICAgaXRlbS5jaGlsZHJlbi5mb3JFYWNoKChjaGlsZDogSUxheWVyTm9kZSB8IElMYXllckZvbGRlcikgPT4ge1xuICAgICAgICAgICAgICAgICAgICBub2RlLmNoaWxkcmVuLnB1c2goU2NlbmVUcmVlVXRpbHMubG9hZExheWVyTm9kZShjaGlsZCkpXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG5vZGUuZXhwYW5kID0gaXRlbS5leHBhbmQ7XG4gICAgICAgICAgICByZXR1cm4gbm9kZTtcbiAgICAgICAgfSBlbHNlIGlmIChpdGVtLnVybCB8fCBpdGVtLmxheWVyKSB7XG4gICAgICAgICAgICAvL+WbvuWxglxuICAgICAgICAgICAgLy8gdGlhbmRpdHUg6ZyA6KaB5bCGbGF5ZXLovazmjaLkuLp1cmxcblxuICAgICAgICAgICAgY29uc3Qgbm9kZTogSVhic2pDem1PYmplY3QgPSBuZXdYYnNqTGF5ZXJOb2RlKGl0ZW0udHlwZSwgaXRlbS50aXRsZSwgaXRlbS51cmwpO1xuICAgICAgICAgICAgbm9kZS5jem1PYmplY3QueGJzakd1aWQgPSBpdGVtLmd1aWQ7XG4gICAgICAgICAgICBub2RlLmN6bU9iamVjdC5zaG93ID0gaXRlbS5zaG93ID8gdHJ1ZSA6IGZhbHNlO1xuICAgICAgICAgICAgbm9kZS5yZWYgPSBpdGVtLnJlZjtcbiAgICAgICAgICAgIGlmIChub2RlLmN6bU9iamVjdC5oYXNPd25Qcm9wZXJ0eShcInhic2pJbWFnZXJ5UHJvdmlkZXJcIikpIHtcbiAgICAgICAgICAgICAgICAvL+W9seWDj+WbvuWxguWkhOeQhlxuICAgICAgICAgICAgICAgIGlmIChpdGVtLnNyY0Nvb3JkVHlwZSkge1xuICAgICAgICAgICAgICAgICAgICAvL+WOn+WdkOagh+ezu1xuICAgICAgICAgICAgICAgICAgICBub2RlLmN6bU9iamVjdC54YnNqSW1hZ2VyeVByb3ZpZGVyLlhic2pJbWFnZXJ5UHJvdmlkZXIuc3JjQ29vcmRUeXBlID0gaXRlbS5zcmNDb29yZFR5cGU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChpdGVtLmRzdENvb3JkVHlwZSkge1xuICAgICAgICAgICAgICAgICAgICAvL+i9rOaNouebruagh+WdkOagh+ezu1xuICAgICAgICAgICAgICAgICAgICBub2RlLmN6bU9iamVjdC54YnNqSW1hZ2VyeVByb3ZpZGVyLlhic2pJbWFnZXJ5UHJvdmlkZXIuZHN0Q29vcmRUeXBlID0gaXRlbS5kc3RDb29yZFR5cGU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLmN6bU9iamVjdC5oYXNPd25Qcm9wZXJ0eShcInhic2pUZXJyYWluUHJvdmlkZXJcIikpIHtcbiAgICAgICAgICAgICAgICAvL+WcsOW9ouWbvuWxguWkhOeQhlxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAobm9kZS5oYXNPd25Qcm9wZXJ0eShcInVybFwiKSkge1xuICAgICAgICAgICAgICAgIC8v55Om54mH5Zu+5bGC5aSE55CGXG5cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChpdGVtLmV4dGVuZE9wdGlvbnMpIHtcblxuICAgICAgICAgICAgICAgIG5vZGUuY3ptT2JqZWN0ID0gT2JqZWN0LmFzc2lnbihub2RlLmN6bU9iamVjdCwgaXRlbS5leHRlbmRPcHRpb25zKTtcbiAgICAgICAgICAgICAgICBpZiAoaXRlbS5leHRlbmRPcHRpb25zLnJlY3RhbmdsZSkge1xuICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhub2RlLmN6bU9iamVjdC5yZWN0YW5nbGUpXG4gICAgICAgICAgICAgICAgICAgIGxldCByZWN0ID0gW11cbiAgICAgICAgICAgICAgICAgICAgbm9kZS5jem1PYmplY3QucmVjdGFuZ2xlLmZvckVhY2goaXRlbSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWN0LnB1c2goaXRlbSAvIDE4MCAqIE1hdGguUEkpXG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgIG5vZGUuY3ptT2JqZWN0LnJlY3RhbmdsZSA9IHJlY3RcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gbm9kZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG59Il19