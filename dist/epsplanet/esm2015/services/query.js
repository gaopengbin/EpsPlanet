import axios from 'axios';
import qs from 'qs';
export class Query {
    constructor() { }
    static ArcgisQuery(czmObject, index, params, callback) {
        if (this.myEntityCollection == undefined) {
            this.myEntityCollection = new Cesium.CustomDataSource('myEntityCollection');
            window['earth'].czm.viewer.dataSources.add(this.myEntityCollection);
        }
        this.myEntityCollection.entities.removeAll();
        let viewer = window['earth'].czm.viewer;
        let type = czmObject.xbsjImageryProvider.type;
        let url = czmObject.xbsjImageryProvider[type].url;
        let requestUrl = "";
        if (czmObject.xbsjImageryProvider.type == "WebMapTileServiceImageryProvider") {
            requestUrl = url.split('MapServer')[0] + `MapServer/${index}/query?geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&relationParam=&outFields=*&returnGeometry=true&maxAllowableOffset=&geometryPrecision=&outSR=4326&returnIdsOnly=false&returnCountOnly=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&returnZ=false&returnM=false&gdbVersion=&returnDistinctValues=false&f=pjson`;
        }
        else if (czmObject.xbsjImageryProvider.type == "SSWebMapServiceImageryProvider") {
            requestUrl = url.split('arcgis')[0] + 'arcgis/rest' + url.split('arcgis')[1].split('MapServer')[0] + `MapServer/${index}/query?geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&relationParam=&outFields=&returnGeometry=true&maxAllowableOffset=&geometryPrecision=&outSR=4326&returnIdsOnly=false&returnCountOnly=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&returnZ=false&returnM=false&gdbVersion=&returnDistinctValues=false&f=pjson`;
            console.log(requestUrl);
        }
        axios.post(requestUrl, qs.stringify({
            outFields: '*',
            where: params,
            f: 'pjson'
        }), {
            headers: {
                'content-type': 'application/x-www-form-urlencoded',
            }
        }).then(res => {
            console.log(res.data.features);
            let features = res.data.features;
            if (res.data.geometryType == "esriGeometryPoint") {
                features.forEach(feature => {
                    this.myEntityCollection.entities.add({
                        position: Cesium.Cartesian3.fromDegrees(feature.geometry.x, feature.geometry.y),
                        point: {
                            color: Cesium.Color.AQUA,
                            pixelSize: 20,
                            outlineColor: Cesium.Color.YELLOW,
                            outlineWidth: 5,
                            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
                            scaleByDistance: new Cesium.NearFarScalar(1500, 1, 20000, 0.3),
                        }
                    });
                });
                viewer.flyTo(this.myEntityCollection);
            }
            if (res.data.geometryType == "esriGeometryPolygon") {
                features.forEach(feature => {
                    let positions = [];
                    feature.geometry.rings[0].forEach(pos => {
                        positions.push(pos[0], pos[1]);
                    });
                    this.myEntityCollection.entities.add({
                        polyline: {
                            positions: Cesium.Cartesian3.fromDegreesArray(positions),
                            width: 10,
                            material: new Cesium.PolylineGlowMaterialProperty({
                                glowPower: 0.2,
                                color: Cesium.Color.BLUE
                            })
                        },
                    });
                });
                viewer.flyTo(this.myEntityCollection);
            }
            if (res.data.geometryType == "esriGeometryPolyline") {
                features.forEach(feature => {
                    let positions = [];
                    feature.geometry.paths[0].forEach(pos => {
                        positions.push(pos[0], pos[1]);
                    });
                    this.myEntityCollection.entities.add({
                        polyline: {
                            positions: Cesium.Cartesian3.fromDegreesArray(positions),
                            width: 10,
                            material: new Cesium.PolylineGlowMaterialProperty({
                                glowPower: 0.2,
                                color: Cesium.Color.BLUE
                            })
                        },
                    });
                });
                viewer.flyTo(this.myEntityCollection);
            }
        });
    }
    static GeoserverQuery(czmObject, params) {
        if (this.myEntityCollection == undefined) {
            this.myEntityCollection = new Cesium.CustomDataSource('myEntityCollection');
            window['earth'].czm.viewer.dataSources.add(this.myEntityCollection);
        }
        this.myEntityCollection.entities.removeAll();
        let viewer = window['earth'].czm.viewer;
        let type = czmObject.xbsjImageryProvider.type;
        let layer = czmObject.xbsjImageryProvider[type].layer;
        let url = czmObject.xbsjImageryProvider[type].url;
        let requestUrl = "";
        if (czmObject.xbsjImageryProvider.type == "WebMapTileServiceImageryProvider") {
            let server = layer.split(':')[0];
            requestUrl = url.split('geoserver')[0] + `geoserver/${server}/wfs?service=wfs&request=GetFeature&version=1.1.0&outputFormat=application/json&TYPENAME=${layer}&cql_filter=${params}`;
        }
        else if (czmObject.xbsjImageryProvider.type == "SSWebMapServiceImageryProvider") {
            let server = url.split('/wms')[0].split('geoserver/')[1];
            requestUrl = url.split('wms')[0] + `wfs?service=wfs&request=GetFeature&version=1.1.0&outputFormat=application/json&TYPENAME=${server}:${layer}&cql_filter=${params}`;
        }
        console.log(requestUrl);
        axios.post(requestUrl).then(res => {
            console.log(res);
            Cesium.GeoJsonDataSource.load(res.data).then(dataSource => {
                dataSource.entities.values.forEach(entity => {
                    this.myEntityCollection.entities.add(entity);
                });
                viewer.flyTo(this.myEntityCollection);
            });
        });
    }
    static clearHighLight() {
        window['earth'].czm.viewer.dataSources.getByName('myEntityCollection')[0].entities.removeAll();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9lcHNwbGFuZXQvc2VydmljZXMvcXVlcnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLE1BQU0sT0FBTyxDQUFBO0FBQ3pCLE9BQU8sRUFBRSxNQUFNLElBQUksQ0FBQTtBQUduQixNQUFNLE9BQU8sS0FBSztJQUVkLGdCQUFnQixDQUFDO0lBUWpCLE1BQU0sQ0FBQyxXQUFXLENBQUMsU0FBUyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsUUFBUTtRQUNqRCxJQUFJLElBQUksQ0FBQyxrQkFBa0IsSUFBSSxTQUFTLEVBQUU7WUFDdEMsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksTUFBTSxDQUFDLGdCQUFnQixDQUFDLG9CQUFvQixDQUFDLENBQUM7WUFDNUUsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQztTQUN2RTtRQUNELElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDN0MsSUFBSSxNQUFNLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUM7UUFDeEMsSUFBSSxJQUFJLEdBQUcsU0FBUyxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQztRQUM5QyxJQUFJLEdBQUcsR0FBRyxTQUFTLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDO1FBQ2xELElBQUksVUFBVSxHQUFHLEVBQUUsQ0FBQTtRQUNuQixJQUFJLFNBQVMsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLElBQUksa0NBQWtDLEVBQUU7WUFDMUUsVUFBVSxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdB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QyxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDekQsVUFBVSxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsMkZBQTJGLE1BQU0sSUFBSSxLQUFLLGVBQWUsTUFBTSxFQUFFLENBQUE7U0FDdks7UUFDRCxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFBO1FBQ3ZCLEtBQUssQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQzlCLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUE7WUFDaEIsTUFBTSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFO2dCQUN0RCxVQUFVLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUU7b0JBTXhDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFBO2dCQUNoRCxDQUFDLENBQUMsQ0FBQTtnQkFDRixNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFBO1lBQ3pDLENBQUMsQ0FBQyxDQUFBO1FBQ04sQ0FBQyxDQUFDLENBQUE7SUFDTixDQUFDO0lBSUQsTUFBTSxDQUFDLGNBQWM7UUFDakIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxTQUFTLEVBQUUsQ0FBQTtJQUNsRyxDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnXHJcbmltcG9ydCBxcyBmcm9tICdxcydcclxuXHJcblxyXG5leHBvcnQgY2xhc3MgUXVlcnkge1xyXG4gICAgc3RhdGljIG15RW50aXR5Q29sbGVjdGlvbjogYW55Oy8v55So5LqO5a2Y5YKo5p+l6K+i6L+H56iL5Lit6auY5Lqu5pi+56S655qEZW50aXR5XHJcbiAgICBjb25zdHJ1Y3RvcigpIHsgfVxyXG4gICAgLyoqXHJcbiAgICAgKiDln7rkuo5BcmNHSVMgU2VydmVy55qE5p+l6K+iXHJcbiAgICAgKiBAcGFyYW0gY3ptT2JqZWN0IOimgeafpeivoueahGN6bU9iamVjdFxyXG4gICAgICogQHBhcmFtIGluZGV4IGFyY2dpcyBzZXJ2ZXLlm77lsYJpZFxyXG4gICAgICogQHBhcmFtIHBhcmFtcyDmn6Xor6Lor63lj6VcclxuICAgICAqIEBwYXJhbSBjYWxsYmFjayDlm57osINcclxuICAgICAqL1xyXG4gICAgc3RhdGljIEFyY2dpc1F1ZXJ5KGN6bU9iamVjdCwgaW5kZXgsIHBhcmFtcywgY2FsbGJhY2spIHtcclxuICAgICAgICBpZiAodGhpcy5teUVudGl0eUNvbGxlY3Rpb24gPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIHRoaXMubXlFbnRpdHlDb2xsZWN0aW9uID0gbmV3IENlc2l1bS5DdXN0b21EYXRhU291cmNlKCdteUVudGl0eUNvbGxlY3Rpb24nKTtcclxuICAgICAgICAgICAgd2luZG93WydlYXJ0aCddLmN6bS52aWV3ZXIuZGF0YVNvdXJjZXMuYWRkKHRoaXMubXlFbnRpdHlDb2xsZWN0aW9uKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5teUVudGl0eUNvbGxlY3Rpb24uZW50aXRpZXMucmVtb3ZlQWxsKCk7XHJcbiAgICAgICAgbGV0IHZpZXdlciA9IHdpbmRvd1snZWFydGgnXS5jem0udmlld2VyO1xyXG4gICAgICAgIGxldCB0eXBlID0gY3ptT2JqZWN0Lnhic2pJbWFnZXJ5UHJvdmlkZXIudHlwZTtcclxuICAgICAgICBsZXQgdXJsID0gY3ptT2JqZWN0Lnhic2pJbWFnZXJ5UHJvdmlkZXJbdHlwZV0udXJsO1xyXG4gICAgICAgIGxldCByZXF1ZXN0VXJsID0gXCJcIlxyXG4gICAgICAgIGlmIChjem1PYmplY3QueGJzakltYWdlcnlQcm92aWRlci50eXBlID09IFwiV2ViTWFwVGlsZVNlcnZpY2VJbWFnZXJ5UHJvdmlkZXJcIikge1xyXG4gICAgICAgICAgICByZXF1ZXN0VXJsID0gdXJsLnNwbGl0KCdNYXBTZXJ2ZXInKVswXSArIGBNYXBTZXJ2ZXIvJHtpbmRleH0vcXVlcnk/Z2VvbWV0cnlUeXBlPWVzcmlHZW9tZXRyeUVudmVsb3BlJmluU1I9JnNwYXRpYWxSZWw9ZXNyaVNwYXRpYWxSZWxJbnRlcnNlY3RzJnJlbGF0aW9uUGFyYW09Jm91dEZpZWxkcz0qJnJldHVybkdlb21ldHJ5PXRydWUmbWF4QWxsb3dhYmxlT2Zmc2V0PSZnZW9tZXRyeVByZWNpc2lvbj0mb3V0U1I9NDMyNiZyZXR1cm5JZHNPbmx5PWZhbHNlJnJldHVybkNvdW50T25seT1mYWxzZSZvcmRlckJ5RmllbGRzPSZncm91cEJ5RmllbGRzRm9yU3RhdGlzdGljcz0mb3V0U3RhdGlzdGljcz0mcmV0dXJuWj1mYWxzZSZyZXR1cm5NPWZhbHNlJmdkYlZlcnNpb249JnJldHVybkRpc3RpbmN0VmFsdWVzPWZhbHNlJmY9cGpzb25gXHJcbiAgICAgICAgfSBlbHNlIGlmIChjem1PYmplY3QueGJzakltYWdlcnlQcm92aWRlci50eXBlID09IFwiU1NXZWJNYXBTZXJ2aWNlSW1hZ2VyeVByb3ZpZGVyXCIpIHtcclxuICAgICAgICAgICAgcmVxdWVzdFVybCA9IHVybC5zcGxpdCgnYXJjZ2lzJylbMF0gKyAnYXJjZ2lzL3Jlc3QnICsgdXJsLnNwbGl0KCdhcmNnaXMnKVsxXS5zcGxpdCgnTWFwU2VydmVyJylbMF0gKyBgTWFwU2VydmVyLyR7aW5kZXh9L3F1ZXJ5P2dlb21ldHJ5VHlwZT1lc3JpR2VvbWV0cnlFbnZlbG9wZSZpblNSPSZzcGF0aWFsUmVsPWVzcmlTcGF0aWFsUmVsSW50ZXJzZWN0cyZyZWxhdGlvblBhcmFtPSZvdXRGaWVsZHM9JnJldHVybkdlb21ldHJ5PXRydWUmbWF4QWxsb3dhYmxlT2Zmc2V0PSZnZW9tZXRyeVByZWNpc2lvbj0mb3V0U1I9NDMyNiZyZXR1cm5JZHNPbmx5PWZhbHNlJnJldHVybkNvdW50T25seT1mYWxzZSZvcmRlckJ5RmllbGRzPSZncm91cEJ5RmllbGRzRm9yU3RhdGlzdGljcz0mb3V0U3RhdGlzdGljcz0mcmV0dXJuWj1mYWxzZSZyZXR1cm5NPWZhbHNlJmdkYlZlcnNpb249JnJldHVybkRpc3RpbmN0VmFsdWVzPWZhbHNlJmY9cGpzb25gO1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhyZXF1ZXN0VXJsKVxyXG4gICAgICAgIH1cclxuICAgICAgICBheGlvcy5wb3N0KHJlcXVlc3RVcmwsXHJcbiAgICAgICAgICAgIHFzLnN0cmluZ2lmeSh7XHJcbiAgICAgICAgICAgICAgICBvdXRGaWVsZHM6JyonLFxyXG4gICAgICAgICAgICAgICAgd2hlcmU6IHBhcmFtcyxcclxuICAgICAgICAgICAgICAgIGY6ICdwanNvbidcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgIGhlYWRlcnM6IHtcclxuICAgICAgICAgICAgICAgICAgICAnY29udGVudC10eXBlJzogJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcsXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pLnRoZW4ocmVzID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlcy5kYXRhLmZlYXR1cmVzKVxyXG4gICAgICAgICAgICAgICAgbGV0IGZlYXR1cmVzID0gcmVzLmRhdGEuZmVhdHVyZXM7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVzLmRhdGEuZ2VvbWV0cnlUeXBlID09IFwiZXNyaUdlb21ldHJ5UG9pbnRcIikge1xyXG4gICAgICAgICAgICAgICAgICAgIGZlYXR1cmVzLmZvckVhY2goZmVhdHVyZSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubXlFbnRpdHlDb2xsZWN0aW9uLmVudGl0aWVzLmFkZChcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbjogQ2VzaXVtLkNhcnRlc2lhbjMuZnJvbURlZ3JlZXMoZmVhdHVyZS5nZW9tZXRyeS54LCBmZWF0dXJlLmdlb21ldHJ5LnkpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvaW50OiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBDZXNpdW0uQ29sb3IuQVFVQSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGl4ZWxTaXplOiAyMCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0bGluZUNvbG9yOiBDZXNpdW0uQ29sb3IuWUVMTE9XLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvdXRsaW5lV2lkdGg6IDUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlaWdodFJlZmVyZW5jZTogQ2VzaXVtLkhlaWdodFJlZmVyZW5jZS5DTEFNUF9UT19HUk9VTkQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjYWxlQnlEaXN0YW5jZTogbmV3IENlc2l1bS5OZWFyRmFyU2NhbGFyKDE1MDAsIDEsIDIwMDAwLCAwLjMpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgdmlld2VyLmZseVRvKHRoaXMubXlFbnRpdHlDb2xsZWN0aW9uKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGlmIChyZXMuZGF0YS5nZW9tZXRyeVR5cGUgPT0gXCJlc3JpR2VvbWV0cnlQb2x5Z29uXCIpIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgZmVhdHVyZXMuZm9yRWFjaChmZWF0dXJlID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBvc2l0aW9ucyA9IFtdXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZlYXR1cmUuZ2VvbWV0cnkucmluZ3NbMF0uZm9yRWFjaChwb3MgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb25zLnB1c2gocG9zWzBdLCBwb3NbMV0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubXlFbnRpdHlDb2xsZWN0aW9uLmVudGl0aWVzLmFkZCh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb2x5bGluZToge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uczogQ2VzaXVtLkNhcnRlc2lhbjMuZnJvbURlZ3JlZXNBcnJheShwb3NpdGlvbnMpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiAxMCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRlcmlhbDogbmV3IENlc2l1bS5Qb2x5bGluZUdsb3dNYXRlcmlhbFByb3BlcnR5KHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2xvd1Bvd2VyOiAwLjIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBDZXNpdW0uQ29sb3IuQkxVRVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB2aWV3ZXIuZmx5VG8odGhpcy5teUVudGl0eUNvbGxlY3Rpb24pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKHJlcy5kYXRhLmdlb21ldHJ5VHlwZSA9PSBcImVzcmlHZW9tZXRyeVBvbHlsaW5lXCIpIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgZmVhdHVyZXMuZm9yRWFjaChmZWF0dXJlID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHBvc2l0aW9ucyA9IFtdXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGZlYXR1cmUuZ2VvbWV0cnkucGF0aHNbMF0uZm9yRWFjaChwb3MgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb25zLnB1c2gocG9zWzBdLCBwb3NbMV0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubXlFbnRpdHlDb2xsZWN0aW9uLmVudGl0aWVzLmFkZCh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb2x5bGluZToge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uczogQ2VzaXVtLkNhcnRlc2lhbjMuZnJvbURlZ3JlZXNBcnJheShwb3NpdGlvbnMpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoOiAxMCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXRlcmlhbDogbmV3IENlc2l1bS5Qb2x5bGluZUdsb3dNYXRlcmlhbFByb3BlcnR5KHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2xvd1Bvd2VyOiAwLjIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiBDZXNpdW0uQ29sb3IuQkxVRVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICB2aWV3ZXIuZmx5VG8odGhpcy5teUVudGl0eUNvbGxlY3Rpb24pO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiDln7rkuo5HZW9zZXJ2ZXLnmoTmn6Xor6JcclxuICAgICAqIEBwYXJhbSBjem1PYmplY3QgXHJcbiAgICAgKiBAcGFyYW0gcGFyYW1zIFxyXG4gICAgICovXHJcbiAgICBzdGF0aWMgR2Vvc2VydmVyUXVlcnkoY3ptT2JqZWN0LCBwYXJhbXMpIHtcclxuICAgICAgICBpZiAodGhpcy5teUVudGl0eUNvbGxlY3Rpb24gPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICAgIHRoaXMubXlFbnRpdHlDb2xsZWN0aW9uID0gbmV3IENlc2l1bS5DdXN0b21EYXRhU291cmNlKCdteUVudGl0eUNvbGxlY3Rpb24nKTtcclxuICAgICAgICAgICAgd2luZG93WydlYXJ0aCddLmN6bS52aWV3ZXIuZGF0YVNvdXJjZXMuYWRkKHRoaXMubXlFbnRpdHlDb2xsZWN0aW9uKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5teUVudGl0eUNvbGxlY3Rpb24uZW50aXRpZXMucmVtb3ZlQWxsKCk7XHJcbiAgICAgICAgbGV0IHZpZXdlciA9IHdpbmRvd1snZWFydGgnXS5jem0udmlld2VyO1xyXG4gICAgICAgIGxldCB0eXBlID0gY3ptT2JqZWN0Lnhic2pJbWFnZXJ5UHJvdmlkZXIudHlwZTtcclxuICAgICAgICBsZXQgbGF5ZXIgPSBjem1PYmplY3QueGJzakltYWdlcnlQcm92aWRlclt0eXBlXS5sYXllcjtcclxuICAgICAgICBsZXQgdXJsID0gY3ptT2JqZWN0Lnhic2pJbWFnZXJ5UHJvdmlkZXJbdHlwZV0udXJsO1xyXG4gICAgICAgIGxldCByZXF1ZXN0VXJsID0gXCJcIlxyXG4gICAgICAgIGlmIChjem1PYmplY3QueGJzakltYWdlcnlQcm92aWRlci50eXBlID09IFwiV2ViTWFwVGlsZVNlcnZpY2VJbWFnZXJ5UHJvdmlkZXJcIikge1xyXG4gICAgICAgICAgICAvL2BodHRwOi8vbG9jYWxob3N0Ojg4MDEvZ2Vvc2VydmVyL3RpZ2VyL3dmcz9zZXJ2aWNlPXdmcyZyZXF1ZXN0PUdldEZlYXR1cmUmdmVyc2lvbj0xLjEuMCZvdXRwdXRGb3JtYXQ9YXBwbGljYXRpb24vanNvbiZUWVBFTkFNRT10aWdlcjpwb2x5X2xhbmRtYXJrcyZjcWxfZmlsdGVyPSR7cGFyYW19YFxyXG4gICAgICAgICAgICBsZXQgc2VydmVyID0gbGF5ZXIuc3BsaXQoJzonKVswXVxyXG4gICAgICAgICAgICByZXF1ZXN0VXJsID0gdXJsLnNwbGl0KCdnZW9zZXJ2ZXInKVswXSArIGBnZW9zZXJ2ZXIvJHtzZXJ2ZXJ9L3dmcz9zZXJ2aWNlPXdmcyZyZXF1ZXN0PUdldEZlYXR1cmUmdmVyc2lvbj0xLjEuMCZvdXRwdXRGb3JtYXQ9YXBwbGljYXRpb24vanNvbiZUWVBFTkFNRT0ke2xheWVyfSZjcWxfZmlsdGVyPSR7cGFyYW1zfWBcclxuICAgICAgICB9IGVsc2UgaWYgKGN6bU9iamVjdC54YnNqSW1hZ2VyeVByb3ZpZGVyLnR5cGUgPT0gXCJTU1dlYk1hcFNlcnZpY2VJbWFnZXJ5UHJvdmlkZXJcIikge1xyXG4gICAgICAgICAgICBsZXQgc2VydmVyID0gdXJsLnNwbGl0KCcvd21zJylbMF0uc3BsaXQoJ2dlb3NlcnZlci8nKVsxXTtcclxuICAgICAgICAgICAgcmVxdWVzdFVybCA9IHVybC5zcGxpdCgnd21zJylbMF0gKyBgd2ZzP3NlcnZpY2U9d2ZzJnJlcXVlc3Q9R2V0RmVhdHVyZSZ2ZXJzaW9uPTEuMS4wJm91dHB1dEZvcm1hdD1hcHBsaWNhdGlvbi9qc29uJlRZUEVOQU1FPSR7c2VydmVyfToke2xheWVyfSZjcWxfZmlsdGVyPSR7cGFyYW1zfWBcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc29sZS5sb2cocmVxdWVzdFVybClcclxuICAgICAgICBheGlvcy5wb3N0KHJlcXVlc3RVcmwpLnRoZW4ocmVzID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2cocmVzKVxyXG4gICAgICAgICAgICBDZXNpdW0uR2VvSnNvbkRhdGFTb3VyY2UubG9hZChyZXMuZGF0YSkudGhlbihkYXRhU291cmNlID0+IHtcclxuICAgICAgICAgICAgICAgIGRhdGFTb3VyY2UuZW50aXRpZXMudmFsdWVzLmZvckVhY2goZW50aXR5ID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBlbnRpdHkucG9seWxpbmUud2lkdGggPSAxMFxyXG4gICAgICAgICAgICAgICAgICAgIC8vIGVudGl0eS5wb2x5bGluZS5tYXRlcmlhbCA9IG5ldyBDZXNpdW0uUG9seWxpbmVHbG93TWF0ZXJpYWxQcm9wZXJ0eSh7XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gICAgIGdsb3dQb3dlcjogMC4yLFxyXG4gICAgICAgICAgICAgICAgICAgIC8vICAgICBjb2xvcjogQ2VzaXVtLkNvbG9yLkJMVUVcclxuICAgICAgICAgICAgICAgICAgICAvLyB9KTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm15RW50aXR5Q29sbGVjdGlvbi5lbnRpdGllcy5hZGQoZW50aXR5KVxyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIHZpZXdlci5mbHlUbyh0aGlzLm15RW50aXR5Q29sbGVjdGlvbilcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICB9KVxyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiDmuIXpmaTpq5jkuq5cclxuICAgICAqL1xyXG4gICAgc3RhdGljIGNsZWFySGlnaExpZ2h0KCkge1xyXG4gICAgICAgIHdpbmRvd1snZWFydGgnXS5jem0udmlld2VyLmRhdGFTb3VyY2VzLmdldEJ5TmFtZSgnbXlFbnRpdHlDb2xsZWN0aW9uJylbMF0uZW50aXRpZXMucmVtb3ZlQWxsKClcclxuICAgIH1cclxufSJdfQ==