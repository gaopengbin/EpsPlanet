import * as _ from "lodash";
import { InjectionToken, Injectable } from '@angular/core';
import { LogService } from "../utils/console-log";
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
export const AppGlobalConfigToken = new InjectionToken('app_global_config');
const defaultGlobalConfigPath = "assets/global.json";
const defuaultConfigPath = "assets/config.json";
export class AppInitService {
    constructor(httpClient) {
        this.httpClient = httpClient;
    }
    getPath() {
        let fullPath, path;
        fullPath = window.location.pathname;
        if (fullPath === '/' || fullPath.substr(fullPath.length - 1) === '/') {
            path = fullPath;
        }
        else {
            let sections = fullPath.split('/');
            path = sections.join('/') + '/';
        }
        return path;
    }
    getUrlParams() {
        let s = window.location.search, p;
        if (s === '') {
            s = window.location.hash;
            if (s && s.indexOf('?') > 0) {
                s = s.substring(s.indexOf('?'));
            }
        }
        if (s === '') {
            return {};
        }
        p = new Object();
        if (s.indexOf("?") != -1) {
            let strs = s.substr(1).split("&");
            for (let i = 0; i < strs.length; i++) {
                p[strs[i].split("=")[0]] = decodeURIComponent((strs[i].split("=")[1]));
            }
        }
        return p;
    }
    init(__config) {
        let __mergedConfig = _.cloneDeep(defaultAppGlobalConfig);
        if (!__mergedConfig.path) {
            __mergedConfig.path = __mergedConfig.appInfo.path = this.getPath();
        }
        __mergedConfig.urlParams = _.merge(__mergedConfig.urlParams, this.getUrlParams());
        if (__mergedConfig.jimuConfig.isDesignMode === true
            && typeof __mergedConfig.urlParams.config === "string" && __mergedConfig.urlParams.config.length >= 1) {
            __mergedConfig.appInfo.configFile = "./project/" + __mergedConfig.urlParams.config + "/config.json";
            __mergedConfig.appInfo.extendInitjs = "./project/" + __mergedConfig.urlParams.config + "/thirdpartyLibs/init.js";
            __mergedConfig.appInfo.folderUrlPrefix = "./project/" + __mergedConfig.urlParams.config;
        }
        if (__config) {
            __mergedConfig = _.merge(__mergedConfig, __config);
        }
        this._mergedConfig = __mergedConfig;
        return this;
    }
    loadGlobalConfig() {
        return new Promise((resolve, reject) => {
            this._mergedConfig.globalConfigFilePath = this._mergedConfig.globalConfigFilePath || defaultGlobalConfigPath;
            if (this._mergedConfig.globalConfigFilePath) {
                this.httpClient.get(this._mergedConfig.globalConfigFilePath).toPromise().then((cfg) => {
                    if (cfg) {
                        this._mergedConfig = Object.assign(Object.assign({}, this._mergedConfig), cfg);
                        if (cfg.title) {
                            document.title = cfg.title;
                        }
                    }
                    LogService.overwriteLog(this._mergedConfig.log);
                    resolve(true);
                }).catch(err => {
                    console.log("配置文件global.json读取失败");
                    resolve(true);
                });
            }
            else {
                console.log("没有global.json");
                resolve(true);
            }
        });
    }
    getConfig() {
        return this._mergedConfig;
    }
}
AppInitService.ɵfac = function AppInitService_Factory(t) { return new (t || AppInitService)(i0.ɵɵinject(i1.HttpClient)); };
AppInitService.ɵprov = i0.ɵɵdefineInjectable({ token: AppInitService, factory: AppInitService.ɵfac, providedIn: 'root' });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(AppInitService, [{
        type: Injectable,
        args: [{ providedIn: 'root' }]
    }], function () { return [{ type: i1.HttpClient }]; }, null); })();
export class AppGlobalConfig {
}
AppGlobalConfig.ɵfac = function AppGlobalConfig_Factory(t) { return new (t || AppGlobalConfig)(); };
AppGlobalConfig.ɵprov = i0.ɵɵdefineInjectable({ token: AppGlobalConfig, factory: AppGlobalConfig.ɵfac, providedIn: 'root' });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(AppGlobalConfig, [{
        type: Injectable,
        args: [{ providedIn: 'root' }]
    }], null, null); })();
export const defaultAppGlobalConfig = {
    title: "EPSGIS",
    subtitle: "山维科技",
    logo: "",
    apiRootUrl: "",
    widgetRootPath: "widgets",
    wabVersion: undefined,
    path: "",
    urlParams: {
        mode: ""
    },
    jimuConfig: {
        zIndex: "auto",
        isDesignMode: false,
        isSettings: false,
        mapId: "mapContainer"
    },
    appInfo: {
        path: "",
        configFile: defuaultConfigPath,
        extendInitjs: "",
        folderUrlPrefix: "",
        appPath: "",
        isRunInMobile: false
    },
    dojoConfig: {
        locale: ""
    },
    epsoConfig: {
        showWorkAreaInAddUser: true,
        defaultCityCode: "520100"
    },
    globalConfigFilePath: defaultGlobalConfigPath,
    menuConfig: {
        notReuseRoutes: [],
        notShowInTabRoutes: [],
        menuData: []
    },
    mapConfig: {
        is3D: false,
        jsApi: ""
    },
    log: true
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwLWNvbmZpZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL2Vwc2dpcy9tb2RlbHMvYXBwLWNvbmZpZy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssQ0FBQyxNQUFNLFFBQVEsQ0FBQztBQUM1QixPQUFPLEVBQUUsY0FBYyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7OztBQUNsRCxNQUFNLENBQUMsTUFBTSxvQkFBb0IsR0FBRyxJQUFJLGNBQWMsQ0FBa0IsbUJBQW1CLENBQUMsQ0FBQztBQUM3RixNQUFNLHVCQUF1QixHQUFXLG9CQUFvQixDQUFDO0FBQzdELE1BQU0sa0JBQWtCLEdBQVcsb0JBQW9CLENBQUM7QUFLeEQsTUFBTSxPQUFPLGNBQWM7SUFhdkIsWUFDWSxVQUFzQjtRQUF0QixlQUFVLEdBQVYsVUFBVSxDQUFZO0lBSWxDLENBQUM7SUFJTyxPQUFPO1FBQ1gsSUFBSSxRQUFRLEVBQUUsSUFBSSxDQUFDO1FBQ25CLFFBQVEsR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQztRQUNwQyxJQUFJLFFBQVEsS0FBSyxHQUFHLElBQUksUUFBUSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxLQUFLLEdBQUcsRUFBRTtZQUNsRSxJQUFJLEdBQUcsUUFBUSxDQUFDO1NBQ25CO2FBQU07WUFDSCxJQUFJLFFBQVEsR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ25DLElBQUksR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEdBQUcsQ0FBQztTQUNuQztRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFJTyxZQUFZO1FBQ2hCLElBQUksQ0FBQyxHQUFHLE1BQU0sQ0FBQyxRQUFRLENB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QUNuQixlQUFlO2NBRDNCLFVBQVU7ZUFBQyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUU7O0FBK0ZsQyxNQUFNLENBQUMsTUFBTSxzQkFBc0IsR0FBb0I7SUFDbkQsS0FBSyxFQUFFLFFBQVE7SUFDZixRQUFRLEVBQUUsTUFBTTtJQUNoQixJQUFJLEVBQUUsRUFBRTtJQUNSLFVBQVUsRUFBRSxFQUFFO0lBRWQsY0FBYyxFQUFFLFNBQVM7SUFDekIsVUFBVSxFQUFFLFNBQVM7SUFDckIsSUFBSSxFQUFFLEVBQUU7SUFDUixTQUFTLEVBQUU7UUFDUCxJQUFJLEVBQUUsRUFBRTtLQUNYO0lBQ0QsVUFBVSxFQUFFO1FBQ1IsTUFBTSxFQUFFLE1BQU07UUFDZCxZQUFZLEVBQUUsS0FBSztRQUNuQixVQUFVLEVBQUUsS0FBSztRQUNqQixLQUFLLEVBQUUsY0FBYztLQUN4QjtJQUNELE9BQU8sRUFBRTtRQUNMLElBQUksRUFBRSxFQUFFO1FBQ1IsVUFBVSxFQUFFLGtCQUFrQjtRQUM5QixZQUFZLEVBQUUsRUFBRTtRQUNoQixlQUFlLEVBQUUsRUFBRTtRQUNuQixPQUFPLEVBQUUsRUFBRTtRQUNYLGFBQWEsRUFBRSxLQUFLO0tBQ3ZCO0lBQ0QsVUFBVSxFQUFFO1FBQ1IsTUFBTSxFQUFFLEVBQUU7S0FDYjtJQUNELFVBQVUsRUFBRTtRQUNSLHFCQUFxQixFQUFFLElBQUk7UUFDM0IsZUFBZSxFQUFFLFFBQVE7S0FDNUI7SUFDRCxvQkFBb0IsRUFBRSx1QkFBdUI7SUFFN0MsVUFBVSxFQUFFO1FBQ1IsY0FBYyxFQUFFLEVBQUU7UUFDbEIsa0JBQWtCLEVBQUUsRUFBRTtRQUN0QixRQUFRLEVBQUUsRUFBRTtLQUNmO0lBQ0QsU0FBUyxFQUFFO1FBQ1AsSUFBSSxFQUFFLEtBQUs7UUFDWCxLQUFLLEVBQUUsRUFBRTtLQUNaO0lBQ0QsR0FBRyxFQUFFLElBQUk7Q0FDWixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgXyBmcm9tIFwibG9kYXNoXCI7XHJcbmltcG9ydCB7IEluamVjdGlvblRva2VuLCBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEh0dHBDbGllbnQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcbmltcG9ydCB7IExvZ1NlcnZpY2UgfSBmcm9tIFwiLi4vdXRpbHMvY29uc29sZS1sb2dcIjtcclxuZXhwb3J0IGNvbnN0IEFwcEdsb2JhbENvbmZpZ1Rva2VuID0gbmV3IEluamVjdGlvblRva2VuPEFwcEdsb2JhbENvbmZpZz4oJ2FwcF9nbG9iYWxfY29uZmlnJyk7XHJcbmNvbnN0IGRlZmF1bHRHbG9iYWxDb25maWdQYXRoOiBzdHJpbmcgPSBcImFzc2V0cy9nbG9iYWwuanNvblwiO1xyXG5jb25zdCBkZWZ1YXVsdENvbmZpZ1BhdGg6IHN0cmluZyA9IFwiYXNzZXRzL2NvbmZpZy5qc29uXCI7XHJcbi8qKlxyXG4gKiBcclxuICovXHJcbkBJbmplY3RhYmxlKHsgcHJvdmlkZWRJbjogJ3Jvb3QnIH0pXHJcbmV4cG9ydCBjbGFzcyBBcHBJbml0U2VydmljZSB7XHJcblxyXG4gICAgcHJpdmF0ZSBfbWVyZ2VkQ29uZmlnOiBBcHBHbG9iYWxDb25maWc7XHJcbiAgICAvKlxyXG4gICAgRXJyb3IgZHVyaW5nIHRlbXBsYXRlIGNvbXBpbGUgb2YgJ2NyZWF0ZUdsb2JhbENvbmZpZydcclxuIEZ1bmN0aW9uIGV4cHJlc3Npb25zIGFyZSBub3Qgc3VwcG9ydGVkIGluIGRlY29yYXRvcnNcclxuICAgQ29uc2lkZXIgY2hhbmdpbmcgdGhlIGZ1bmN0aW9uIGV4cHJlc3Npb24gaW50byBhbiBleHBvcnRlZCBmdW5jdGlvbi5cclxuICAgKi9cclxuXHJcbiAgICAvKipcclxuICAgICAqIFxyXG4gICAgICogQHBhcmFtIGNvbmZpZyBcclxuICAgICAqL1xyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgcHJpdmF0ZSBodHRwQ2xpZW50OiBIdHRwQ2xpZW50XHJcbiAgICAgICAgLy/CoOi/memHjOS4jeiDveazqOWFpUFjdGl2YXRlZFJvdXRl77yfXHJcbiAgICAgICAgLy8gICAgLCBwcml2YXRlIHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZVxyXG4gICAgKSB7XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIFxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGdldFBhdGgoKTogc3RyaW5nIHtcclxuICAgICAgICBsZXQgZnVsbFBhdGgsIHBhdGg7XHJcbiAgICAgICAgZnVsbFBhdGggPSB3aW5kb3cubG9jYXRpb24ucGF0aG5hbWU7XHJcbiAgICAgICAgaWYgKGZ1bGxQYXRoID09PSAnLycgfHwgZnVsbFBhdGguc3Vic3RyKGZ1bGxQYXRoLmxlbmd0aCAtIDEpID09PSAnLycpIHtcclxuICAgICAgICAgICAgcGF0aCA9IGZ1bGxQYXRoO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGxldCBzZWN0aW9ucyA9IGZ1bGxQYXRoLnNwbGl0KCcvJyk7XHJcbiAgICAgICAgICAgIHBhdGggPSBzZWN0aW9ucy5qb2luKCcvJykgKyAnLyc7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBwYXRoO1xyXG4gICAgfVxyXG4gICAgLyoqXHJcbiAgICAgKiBcclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBnZXRVcmxQYXJhbXMoKSB7XHJcbiAgICAgICAgbGV0IHMgPSB3aW5kb3cubG9jYXRpb24uc2VhcmNoLFxyXG4gICAgICAgICAgICBwO1xyXG4gICAgICAgIGlmIChzID09PSAnJykge1xyXG4gICAgICAgICAgICBzID0gd2luZG93LmxvY2F0aW9uLmhhc2g7XHJcbiAgICAgICAgICAgIGlmIChzICYmIHMuaW5kZXhPZignPycpID4gMCkge1xyXG4gICAgICAgICAgICAgICAgcyA9IHMuc3Vic3RyaW5nKHMuaW5kZXhPZignPycpKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAocyA9PT0gJycpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHt9O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcCA9IG5ldyBPYmplY3QoKTtcclxuICAgICAgICBpZiAocy5pbmRleE9mKFwiP1wiKSAhPSAtMSkge1xyXG4gICAgICAgICAgICBsZXQgc3RycyA9IHMuc3Vic3RyKDEpLnNwbGl0KFwiJlwiKTtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdHJzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBwW3N0cnNbaV0uc3BsaXQoXCI9XCIpWzBdXSA9IGRlY29kZVVSSUNvbXBvbmVudCgoc3Ryc1tpXS5zcGxpdChcIj1cIilbMV0pKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHA7XHJcbiAgICB9XHJcbiAgICAvKipcclxuICAgICAqIFxyXG4gICAgICogQHBhcmFtIF9fY29uZmlnIFxyXG4gICAgICovXHJcbiAgICBpbml0KF9fY29uZmlnOiBBcHBHbG9iYWxDb25maWcpIHtcclxuICAgICAgICBsZXQgX19tZXJnZWRDb25maWcgPSBfLmNsb25lRGVlcChkZWZhdWx0QXBwR2xvYmFsQ29uZmlnKVxyXG4gICAgICAgIGlmICghX19tZXJnZWRDb25maWcucGF0aCkge1xyXG4gICAgICAgICAgICBfX21lcmdlZENvbmZpZy5wYXRoID0gX19tZXJnZWRDb25maWcuYXBwSW5mby5wYXRoID0gdGhpcy5nZXRQYXRoKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIF9fbWVyZ2VkQ29uZmlnLnVybFBhcmFtcyA9IF8ubWVyZ2UoX19tZXJnZWRDb25maWcudXJsUGFyYW1zLCB0aGlzLmdldFVybFBhcmFtcygpKTtcclxuXHJcbiAgICAgICAgaWYgKF9fbWVyZ2VkQ29uZmlnLmppbXVDb25maWcuaXNEZXNpZ25Nb2RlID09PSB0cnVlXHJcbiAgICAgICAgICAgICYmIHR5cGVvZiBfX21lcmdlZENvbmZpZy51cmxQYXJhbXMuY29uZmlnID09PSBcInN0cmluZ1wiICYmIF9fbWVyZ2VkQ29uZmlnLnVybFBhcmFtcy5jb25maWcubGVuZ3RoID49IDEpIHtcclxuICAgICAgICAgICAgX19tZXJnZWRDb25maWcuYXBwSW5mby5jb25maWdGaWxlID0gXCIuL3Byb2plY3QvXCIgKyBfX21lcmdlZENvbmZpZy51cmxQYXJhbXMuY29uZmlnICsgXCIvY29uZmlnLmpzb25cIjtcclxuICAgICAgICAgICAgX19tZXJnZWRDb25maWcuYXBwSW5mby5leHRlbmRJbml0anMgPSBcIi4vcHJvamVjdC9cIiArIF9fbWVyZ2VkQ29uZmlnLnVybFBhcmFtcy5jb25maWcgKyBcIi90aGlyZHBhcnR5TGlicy9pbml0LmpzXCI7XHJcbiAgICAgICAgICAgIF9fbWVyZ2VkQ29uZmlnLmFwcEluZm8uZm9sZGVyVXJsUHJlZml4ID0gXCIuL3Byb2plY3QvXCIgKyBfX21lcmdlZENvbmZpZy51cmxQYXJhbXMuY29uZmlnO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoX19jb25maWcpIHtcclxuICAgICAgICAgICAgX19tZXJnZWRDb25maWcgPSBfLm1lcmdlKF9fbWVyZ2VkQ29uZmlnLCBfX2NvbmZpZyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuX21lcmdlZENvbmZpZyA9IF9fbWVyZ2VkQ29uZmlnOyAvL18uY2xvbmVEZWVwKF9fbWVyZ2VkQ29uZmlnKTtcclxuICAgICAgICByZXR1cm4gdGhpcztcclxuICAgIH1cclxuICAgIGxvYWRHbG9iYWxDb25maWcoKTogUHJvbWlzZTxib29sZWFuPiB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5fbWVyZ2VkQ29uZmlnLmdsb2JhbENvbmZpZ0ZpbGVQYXRoID0gdGhpcy5fbWVyZ2VkQ29uZmlnLmdsb2JhbENvbmZpZ0ZpbGVQYXRoIHx8IGRlZmF1bHRHbG9iYWxDb25maWdQYXRoO1xyXG4gICAgICAgICAgICBpZiAodGhpcy5fbWVyZ2VkQ29uZmlnLmdsb2JhbENvbmZpZ0ZpbGVQYXRoKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmh0dHBDbGllbnQuZ2V0KHRoaXMuX21lcmdlZENvbmZpZy5nbG9iYWxDb25maWdGaWxlUGF0aCkudG9Qcm9taXNlKCkudGhlbigoY2ZnOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAvL3RoaXMuX21lcmdlZENvbmZpZy5nbG9iYWxDb25maWcgPSB7IC4uLnRoaXMuX21lcmdlZENvbmZpZy5nbG9iYWxDb25maWcsIC4uLmNmZyB9O1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChjZmcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbWVyZ2VkQ29uZmlnID0geyAuLi50aGlzLl9tZXJnZWRDb25maWcsIC4uLmNmZyB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2ZnLnRpdGxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC50aXRsZSA9IGNmZy50aXRsZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBMb2dTZXJ2aWNlLm92ZXJ3cml0ZUxvZyh0aGlzLl9tZXJnZWRDb25maWcubG9nKTtcclxuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHRydWUpO1xyXG4gICAgICAgICAgICAgICAgfSkuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIumFjee9ruaWh+S7tmdsb2JhbC5qc29u6K+75Y+W5aSx6LSlXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUodHJ1ZSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwi5rKh5pyJZ2xvYmFsLmpzb25cIik7XHJcbiAgICAgICAgICAgICAgICByZXNvbHZlKHRydWUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBnZXRDb25maWcoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX21lcmdlZENvbmZpZztcclxuICAgIH1cclxuXHJcbn1cclxuLyoqXHJcbiAqIOezu+e7n+mFjee9rlxyXG4gKi9cclxuQEluamVjdGFibGUoeyBwcm92aWRlZEluOiAncm9vdCcgfSlcclxuZXhwb3J0IGNsYXNzIEFwcEdsb2JhbENvbmZpZyB7XHJcbiAgICB0aXRsZT86IHN0cmluZztcclxuICAgIHN1YnRpdGxlPzogc3RyaW5nO1xyXG4gICAgbG9nbz86IHN0cmluZztcclxuICAgIGFwaVJvb3RVcmw/OiBzdHJpbmc7XHJcbiAgICAvKipcclxuICAgICAqIOWumuaXtuS7u+WKoeacjeWKoeWcsOWdgFxyXG4gICAgICovXHJcbiAgICBqb2JBcGlVcmw/OnN0cmluZztcclxuICAgIC8qKlxyXG4gICAgICogc2V0dGluZ+acjeWKoeWcsOWdgFxyXG4gICAgICog5pyN5Yqh6LaK5p2l6LaK5aSa77yM6KaB5pW05Li65pyN5Yqh44CC44CC44CC572R5YWz5LqG44CC44CC44CCXHJcbiAgICAgKi9cclxuICAgIHNldHRpbmdBcGlVcmw/OnN0cmluZztcclxuICAgIC8vIGlzM0Q/OiBib29sZWFuO1xyXG4gICAgd2lkZ2V0Um9vdFBhdGg/OiBzdHJpbmc7XHJcbiAgICB3YWJWZXJzaW9uPzogc3RyaW5nO1xyXG4gICAgcGF0aD86IHN0cmluZztcclxuICAgIHVybFBhcmFtcz86IFVybFBhcmFtcztcclxuICAgIGppbXVDb25maWc/OiBKaW11Q29uZmlnO1xyXG4gICAgYXBwSW5mbz86IEFwcEluZm87XHJcbiAgICBkb2pvQ29uZmlnPzogRG9qb0NvbmZpZztcclxuICAgIGVwc29Db25maWc/OiBFcHNvQ29uZmlnO1xyXG4gICAgZ2xvYmFsQ29uZmlnRmlsZVBhdGg/OiBzdHJpbmc7XHJcbiAgICAvLyBnbG9iYWxDb25maWc/OiBhbnk7XHJcbiAgICBtZW51Q29uZmlnPzoge1xyXG4gICAgICAgIG5vdFJldXNlUm91dGVzPzogQXJyYXk8U3RyaW5nPjtcclxuICAgICAgICBub3RTaG93SW5UYWJSb3V0ZXM/OiBBcnJheTxTdHJpbmc+LFxyXG4gICAgICAgIG1lbnVEYXRhPzogQXJyYXk8TWVudUl0ZW0+XHJcbiAgICB9O1xyXG4gICAgbWFwQ29uZmlnPzoge1xyXG4gICAgICAgIGlzM0Q/OiBib29sZWFuO1xyXG4gICAgICAgIGpzQXBpPzogc3RyaW5nO1xyXG4gICAgICAgIFtrZXk6IHN0cmluZ106IGFueTtcclxuICAgIH07XHJcbiAgICAvKipcclxuICAgICAqIOaYr+WQpui+k+WHuuaXpeW/l1xyXG4gICAgICovXHJcbiAgICBsb2c/OiBib29sZWFuO1xyXG4gICAgW2tleTogc3RyaW5nXTogYW55O1xyXG59XHJcbi8qKlxyXG4gKiBcclxuICovXHJcbmludGVyZmFjZSBKaW11Q29uZmlnIHtcclxuICAgIG1hcElkPzogc3RyaW5nO1xyXG4gICAgekluZGV4Pzogc3RyaW5nO1xyXG4gICAgaXNTZXR0aW5ncz86IGJvb2xlYW47XHJcbiAgICBpc0Rlc2lnbk1vZGU/OiBib29sZWFuO1xyXG4gICAgW2tleTogc3RyaW5nXTogYW55O1xyXG59XHJcbi8qKlxyXG4gKiBcclxuICovXHJcbmludGVyZmFjZSBBcHBJbmZvIHtcclxuICAgIHBhdGg/OiBzdHJpbmc7XHJcbiAgICBjb25maWdGaWxlPzogc3RyaW5nO1xyXG4gICAgZXh0ZW5kSW5pdGpzPzogc3RyaW5nO1xyXG4gICAgZm9sZGVyVXJsUHJlZml4Pzogc3RyaW5nO1xyXG4gICAgYXBwUGF0aD86IHN0cmluZztcclxuICAgIGlzUnVuSW5Nb2JpbGU/OiBib29sZWFuO1xyXG4gICAgW2tleTogc3RyaW5nXTogYW55O1xyXG59XHJcbi8qKlxyXG4gKiBcclxuICovXHJcbmludGVyZmFjZSBEb2pvQ29uZmlnIHtcclxuICAgIGxvY2FsZT86IHN0cmluZztcclxuICAgIFtrZXk6IHN0cmluZ106IGFueTtcclxufVxyXG4vKipcclxuICogXHJcbiAqL1xyXG5pbnRlcmZhY2UgVXJsUGFyYW1zIHtcclxuICAgIFtrZXk6IHN0cmluZ106IHN0cmluZyB8IG51bWJlciB8IGJvb2xlYW47XHJcbn1cclxuaW50ZXJmYWNlIEVwc29Db25maWcge1xyXG4gICAgc2hvd1dvcmtBcmVhSW5BZGRVc2VyPzogYm9vbGVhbjtcclxuICAgIFdvcmtBcmVhTWluRGVwdGhJbkFkZFVzZXI/OiBudW1iZXI7XHJcbiAgICBkZWZhdWx0Q2l0eUNvZGU/OiBzdHJpbmc7XHJcbiAgICBba2V5OiBzdHJpbmddOiBhbnk7XHJcbn1cclxuLyoqXHJcbiAqIOS4tOaXtui/meS5iOWkhOeQhuS4i1xyXG4gKi9cclxuaW50ZXJmYWNlIE1lbnVJdGVtIHtcclxuICAgIG5hbWU/OiBzdHJpbmc7XHJcbiAgICBwYXRoPzogc3RyaW5nO1xyXG4gICAgY2hpbGRyZW4/OiBNZW51SXRlbVtdO1xyXG4gICAgW2tleTogc3RyaW5nXTogYW55XHJcbn1cclxuLyoqXHJcbiAqIOm7mOiupOmFjee9rlxyXG4gKi9cclxuZXhwb3J0IGNvbnN0IGRlZmF1bHRBcHBHbG9iYWxDb25maWc6IEFwcEdsb2JhbENvbmZpZyA9IHtcclxuICAgIHRpdGxlOiBcIkVQU0dJU1wiLFxyXG4gICAgc3VidGl0bGU6IFwi5bGx57u056eR5oqAXCIsXHJcbiAgICBsb2dvOiBcIlwiLFxyXG4gICAgYXBpUm9vdFVybDogXCJcIixcclxuICAgIC8vIGlzM0Q6IGZhbHNlLFxyXG4gICAgd2lkZ2V0Um9vdFBhdGg6IFwid2lkZ2V0c1wiLFxyXG4gICAgd2FiVmVyc2lvbjogdW5kZWZpbmVkLFxyXG4gICAgcGF0aDogXCJcIixcclxuICAgIHVybFBhcmFtczoge1xyXG4gICAgICAgIG1vZGU6IFwiXCJcclxuICAgIH0sXHJcbiAgICBqaW11Q29uZmlnOiB7XHJcbiAgICAgICAgekluZGV4OiBcImF1dG9cIixcclxuICAgICAgICBpc0Rlc2lnbk1vZGU6IGZhbHNlLFxyXG4gICAgICAgIGlzU2V0dGluZ3M6IGZhbHNlLFxyXG4gICAgICAgIG1hcElkOiBcIm1hcENvbnRhaW5lclwiXHJcbiAgICB9LFxyXG4gICAgYXBwSW5mbzoge1xyXG4gICAgICAgIHBhdGg6IFwiXCIsXHJcbiAgICAgICAgY29uZmlnRmlsZTogZGVmdWF1bHRDb25maWdQYXRoLFxyXG4gICAgICAgIGV4dGVuZEluaXRqczogXCJcIixcclxuICAgICAgICBmb2xkZXJVcmxQcmVmaXg6IFwiXCIsXHJcbiAgICAgICAgYXBwUGF0aDogXCJcIixcclxuICAgICAgICBpc1J1bkluTW9iaWxlOiBmYWxzZVxyXG4gICAgfSxcclxuICAgIGRvam9Db25maWc6IHtcclxuICAgICAgICBsb2NhbGU6IFwiXCJcclxuICAgIH0sXHJcbiAgICBlcHNvQ29uZmlnOiB7XHJcbiAgICAgICAgc2hvd1dvcmtBcmVhSW5BZGRVc2VyOiB0cnVlLFxyXG4gICAgICAgIGRlZmF1bHRDaXR5Q29kZTogXCI1MjAxMDBcIlxyXG4gICAgfSxcclxuICAgIGdsb2JhbENvbmZpZ0ZpbGVQYXRoOiBkZWZhdWx0R2xvYmFsQ29uZmlnUGF0aCxcclxuICAgIC8vIGdsb2JhbENvbmZpZzoge30sXHJcbiAgICBtZW51Q29uZmlnOiB7XHJcbiAgICAgICAgbm90UmV1c2VSb3V0ZXM6IFtdLFxyXG4gICAgICAgIG5vdFNob3dJblRhYlJvdXRlczogW10sXHJcbiAgICAgICAgbWVudURhdGE6IFtdXHJcbiAgICB9LFxyXG4gICAgbWFwQ29uZmlnOiB7XHJcbiAgICAgICAgaXMzRDogZmFsc2UsXHJcbiAgICAgICAganNBcGk6IFwiXCJcclxuICAgIH0sXHJcbiAgICBsb2c6IHRydWVcclxufTsiXX0=