import { Injectable, Injector, SkipSelf, Optional, TemplateRef } from '@angular/core';
import { SsModalRef } from '../components/modal/modal-ref';
import { Subject, defer } from 'rxjs';
import { startWith } from 'rxjs/operators';
import { SsModalOptions } from '../components/modal/modal-types';
import { setContentInstanceParams, applyConfigDefaults } from '../components/modal/utils';
import { PortalInjector, ComponentPortal } from '@angular/cdk/portal';
import { ModalContainerComponent } from '../components/modal/modal-container/modal-container.component';
import { OverlayRef } from '@angular/cdk/overlay';
import { findComponentInfo } from '../decorator/component-register.decorator';
import * as i0 from "@angular/core";
import * as i1 from "@angular/cdk/overlay";
import * as i2 from "./common.service";
export class ModalManagerService {
    constructor(overlay, injector, parentModal, componentFactoryResolver, appRef, commonService) {
        this.overlay = overlay;
        this.injector = injector;
        this.parentModal = parentModal;
        this.componentFactoryResolver = componentFactoryResolver;
        this.appRef = appRef;
        this.commonService = commonService;
        this.openModalsAtThisLevel = [];
        this.afterAllClosedAtThisLevel = new Subject();
        this.factories = new Map();
        this.factoriesArray = null;
        this.afterAllClose = defer(() => this.openModals.length ? this._afterAllClosed : this._afterAllClosed.pipe(startWith(undefined)));
        this.modalContainerClass = "ssmodal_container";
        this.factories = this.componentFactoryResolver["_factories"];
        if (this.factories) {
            this.factoriesArray = Array.from(this.factories);
        }
    }
    get openModals() {
        return this.parentModal ? this.parentModal.openModals : this.openModalsAtThisLevel;
    }
    get _afterAllClosed() {
        const parent = this.parentModal;
        return parent ? parent._afterAllClosed : this.afterAllClosedAtThisLevel;
    }
    createModalContainer() {
        let container = document.querySelector(this.modalContainerClass);
        if (container == null) {
            container = window.document.createElement("div");
            container.className = this.modalContainerClass;
            window.document.body.appendChild(container);
        }
        this.modalContainer = container;
    }
    create(config) {
        return this.open(config.content, config);
    }
    closeAll() {
        this.closeModals(this.openModals);
    }
    attachModalContainer2(overlayRef, config) {
        const userInjector = config && config.viewContainerRef && config.viewContainerRef.injector;
        const injector = new PortalInjector(userInjector || this.injector, new WeakMap([
            [OverlayRef, overlayRef],
            [SsModalOptions, config]
        ]));
        const ContainerComponent = ModalContainerComponent;
        const containerPortal = new ComponentPortal(ContainerComponent, config.viewContainerRef, injector);
        const containerRef = overlayRef.attach(containerPortal);
        return containerRef.instance;
    }
    open(componentOrTemplateRef, config) {
        const configMerged = applyConfigDefaults(config || {}, new SsModalOptions());
        const modalContainerRef = this.attachModalContainer(configMerged);
        const modalRef = this.attachModalContent(componentOrTemplateRef, configMerged, modalContainerRef);
        modalContainerRef.instance.modalRef = modalRef;
        this.openModals.push(modalRef);
        modalRef.afterClose.subscribe(() => this.removeOpenModal(modalRef));
        return modalRef;
    }
    removeOpenModal(modalRef) {
        const index = this.openModals.indexOf(modalRef);
        if (index > -1) {
            this.openModals.splice(index, 1);
            if (!this.openModals.length) {
                this._afterAllClosed.next();
            }
        }
    }
    closeModals(dialogs) {
        let i = dialogs.length;
        while (i--) {
            dialogs[i].close();
            if (!this.openModals.length) {
                this._afterAllClosed.next();
            }
        }
    }
    attachModalContainer(config) {
        const userInjector = config && config.viewContainerRef && config.viewContainerRef.injector;
        const injector = new PortalInjector(userInjector || this.injector, new WeakMap([
            [SsModalOptions, config]
        ]));
        this.createModalContainer();
        let inputs = {
            config: config
        };
        let inputProviders = Object.keys(inputs).map((inputName) => {
            return { provide: inputName, useValue: inputs[inputName] };
        });
        const ContainerComponent = ModalContainerComponent;
        const factory = this.componentFactoryResolver.resolveComponentFactory(ContainerComponent);
        const injectorc = Injector.create({ providers: inputProviders, parent: injector });
        const containerRef = factory.create(injectorc);
        this.modalContainer.appendChild(this.commonService.getComponentRootNode(containerRef));
        this.appRef.attachView(containerRef.hostView);
        return containerRef;
    }
    findComponent(name) {
        let comp = null;
        if (this.factories) {
            if (!this.factories || this.factories.size <= 0)
                return null;
            let item = this.factoriesArray.find((value, index, arr) => {
                return value[1].selector.toLowerCase() === name.toLowerCase() || value[0].name.toLowerCase() === name.toLocaleLowerCase();
            });
            if (item) {
                comp = item[0];
            }
        }
        else {
            const compInfo = findComponentInfo(name);
            if (compInfo) {
                return compInfo.component;
            }
        }
        return comp;
    }
    attachModalContent(componentOrTemplateRef, config, modalContainerRef) {
        const modalRef = new SsModalRef(config, modalContainerRef);
        if (componentOrTemplateRef instanceof TemplateRef) {
        }
        else if (componentOrTemplateRef && typeof componentOrTemplateRef !== 'string') {
            let inputs = {};
            if (config.componentParams) {
                inputs = config.componentParams;
            }
            let inputProviders = Object.keys(inputs).map((inputName) => {
                return { provide: inputName, useValue: inputs[inputName] };
            });
            let component = componentOrTemplateRef;
            if (this.factories && !this.factories.get(componentOrTemplateRef)) {
                component = this.findComponent(componentOrTemplateRef.name);
            }
            const factory = this.componentFactoryResolver.resolveComponentFactory(component);
            const injector = Injector.create({ providers: inputProviders, parent: this.createInjector(modalRef, config) });
            const compRef = factory.create(injector);
            setContentInstanceParams(compRef.instance, config.componentParams);
            modalContainerRef.instance.attachComponentPortal(compRef);
            modalRef.componentInstance = compRef.instance;
            modalRef.componentRef = compRef;
        }
        return modalRef;
    }
    createInjector(modalRef, config) {
        const userInjector = config && config.viewContainerRef && config.viewContainerRef.injector;
        const injectionTokens = new WeakMap([[SsModalRef, modalRef]]);
        return new PortalInjector(userInjector || this.injector, injectionTokens);
    }
    ngOnDestroy() {
        this.closeModals(this.openModalsAtThisLevel);
        this.afterAllClosedAtThisLevel.complete();
    }
}
ModalManagerService.ɵfac = function ModalManagerService_Factory(t) { return new (t || ModalManagerService)(i0.ɵɵinject(i1.Overlay), i0.ɵɵinject(i0.Injector), i0.ɵɵinject(ModalManagerService, 12), i0.ɵɵinject(i0.ComponentFactoryResolver), i0.ɵɵinject(i0.ApplicationRef), i0.ɵɵinject(i2.CommonService)); };
ModalManagerService.ɵprov = i0.ɵɵdefineInjectable({ token: ModalManagerService, factory: ModalManagerService.ɵfac, providedIn: 'root' });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(ModalManagerService, [{
        type: Injectable,
        args: [{ providedIn: 'root' }]
    }], function () { return [{ type: i1.Overlay }, { type: i0.Injector }, { type: ModalManagerService, decorators: [{
                type: Optional
            }, {
                type: SkipSelf
            }] }, { type: i0.ComponentFactoryResolver }, { type: i0.ApplicationRef }, { type: i2.CommonService }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kYWwtbWFuYWdlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvZXBzZ2lzL3NlcnZpY2VzL21vZGFsLW1hbmFnZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFhLFFBQVEsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBb0YsTUFBTSxlQUFlLENBQUM7QUFDbkwsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQzNELE9BQU8sRUFBRSxPQUFPLEVBQWMsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2xELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMzQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFDakUsT0FBTyxFQUFFLHdCQUF3QixFQUFFLG1CQUFtQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDMUYsT0FBTyxFQUFFLGNBQWMsRUFBRSxlQUFlLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN0RSxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSwrREFBK0QsQ0FBQztBQUl4RyxPQUFPLEVBQUUsVUFBVSxFQUEwQixNQUFNLHNCQUFzQixDQUFDO0FBQzFFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLDJDQUEyQyxDQUFDOzs7O0FBUTlFLE1BQU0sT0FBTyxtQkFBbUI7SUFpQjlCLFlBQ1UsT0FBZ0IsRUFDaEIsUUFBa0IsRUFDTSxXQUFnQyxFQUN4RCx3QkFBa0QsRUFDbEQsTUFBc0IsRUFDdEIsYUFBNEI7UUFMNUIsWUFBTyxHQUFQLE9BQU8sQ0FBUztRQUNoQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ00sZ0JBQVcsR0FBWCxXQUFXLENBQXFCO1FBQ3hELDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBMEI7UUFDbEQsV0FBTSxHQUFOLE1B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Q3pDLHdCQUF3QixDQUFJLE9BQU8sQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQ3RFLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxxQkFBcUIsQ0FBSSxPQUFPLENBQUMsQ0FBQztZQUM3RCxRQUFRLENBQUMsaUJBQWlCLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQztZQUM5QyxRQUFRLENBQUMsWUFBWSxHQUFHLE9BQU8sQ0FBQztTQUNqQztRQUNELE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUFFTyxjQUFjLENBQU8sUUFBMEIsRUFBRSxNQUF5QjtRQUNoRixNQUFNLFlBQVksR0FBRyxNQUFNLElBQUksTUFBTSxDQUFDLGdCQUFnQixJQUFJLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUM7UUFDM0YsTUFBTSxlQUFlLEdBQUcsSUFBSSxPQUFPLENBQVcsQ0FBQyxDQUFDLFVBQVUsRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFeEUsT0FBTyxJQUFJLGNBQWMsQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRSxlQUFlLENBQUMsQ0FBQztJQUM1RSxDQUFDO0lBR0QsV0FBVztRQUNULElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLENBQUM7UUFDN0MsSUFBSSxDQUFDLHlCQUF5QixDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQzVDLENBQUM7O3NGQXBRVSxtQkFBbUIsaUVBb0JpQixtQkFBbUI7MkRBcEJ2RCxtQkFBbUIsV0FBbkIsbUJBQW1CLG1CQUROLE1BQU07dUZBQ25CLG1CQUFtQjtjQUQvQixVQUFVO2VBQUMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFO21GQXFCZSxtQkFBbUI7c0JBQS9ELFFBQVE7O3NCQUFJLFFBQVEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlLCBPbkRlc3Ryb3ksIEluamVjdG9yLCBTa2lwU2VsZiwgT3B0aW9uYWwsIFRlbXBsYXRlUmVmLCBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsIFJlZmxlY3RpdmVJbmplY3RvciwgQXBwbGljYXRpb25SZWYsIENvbXBvbmVudFJlZiwgVHlwZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU3NNb2RhbFJlZiB9IGZyb20gJy4uL2NvbXBvbmVudHMvbW9kYWwvbW9kYWwtcmVmJztcbmltcG9ydCB7IFN1YmplY3QsIE9ic2VydmFibGUsIGRlZmVyIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBzdGFydFdpdGggfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBTc01vZGFsT3B0aW9ucyB9IGZyb20gJy4uL2NvbXBvbmVudHMvbW9kYWwvbW9kYWwtdHlwZXMnO1xuaW1wb3J0IHsgc2V0Q29udGVudEluc3RhbmNlUGFyYW1zLCBhcHBseUNvbmZpZ0RlZmF1bHRzIH0gZnJvbSAnLi4vY29tcG9uZW50cy9tb2RhbC91dGlscyc7XG5pbXBvcnQgeyBQb3J0YWxJbmplY3RvciwgQ29tcG9uZW50UG9ydGFsIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL3BvcnRhbCc7XG5pbXBvcnQgeyBNb2RhbENvbnRhaW5lckNvbXBvbmVudCB9IGZyb20gJy4uL2NvbXBvbmVudHMvbW9kYWwvbW9kYWwtY29udGFpbmVyL21vZGFsLWNvbnRhaW5lci5jb21wb25lbnQnO1xuaW1wb3J0IHsgQ29tcG9uZW50VHlwZSB9IGZyb20gJy4vc2VydmljZXMnO1xuaW1wb3J0IHsgQ29tbW9uU2VydmljZSB9IGZyb20gJy4vY29tbW9uLnNlcnZpY2UnO1xuaW1wb3J0IHsgU2VydmljZUluamVjdG9yIH0gZnJvbSAnLi9zZXJ2aWNlLWluamVjdG9yJztcbmltcG9ydCB7IE92ZXJsYXlSZWYsIE92ZXJsYXlDb25maWcsIE92ZXJsYXkgfSBmcm9tICdAYW5ndWxhci9jZGsvb3ZlcmxheSc7XG5pbXBvcnQgeyBmaW5kQ29tcG9uZW50SW5mbyB9IGZyb20gJy4uL2RlY29yYXRvci9jb21wb25lbnQtcmVnaXN0ZXIuZGVjb3JhdG9yJztcbnR5cGUgQ29udGVudFR5cGU8VD4gPSBDb21wb25lbnRUeXBlPFQ+IHwgVGVtcGxhdGVSZWY8VD4gfCBzdHJpbmc7XG5cbi8qKlxuICog5qih5oCB5a+56K+d5qGGIFxuICogY3JlYXRlIGJ5IDIwMjAwNTA4XG4gKi9cbkBJbmplY3RhYmxlKHsgcHJvdmlkZWRJbjogJ3Jvb3QnIH0pXG5leHBvcnQgY2xhc3MgTW9kYWxNYW5hZ2VyU2VydmljZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XG4gIHByaXZhdGUgb3Blbk1vZGFsc0F0VGhpc0xldmVsOiBTc01vZGFsUmVmW10gPSBbXTtcbiAgcHJpdmF0ZSByZWFkb25seSBhZnRlckFsbENsb3NlZEF0VGhpc0xldmVsID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcbiAgZmFjdG9yaWVzID0gbmV3IE1hcCgpO1xuICBmYWN0b3JpZXNBcnJheTogQXJyYXk8YW55PiA9IG51bGw7XG4gIGdldCBvcGVuTW9kYWxzKCk6IFNzTW9kYWxSZWZbXSB7XG4gICAgcmV0dXJuIHRoaXMucGFyZW50TW9kYWwgPyB0aGlzLnBhcmVudE1vZGFsLm9wZW5Nb2RhbHMgOiB0aGlzLm9wZW5Nb2RhbHNBdFRoaXNMZXZlbDtcbiAgfVxuXG4gIGdldCBfYWZ0ZXJBbGxDbG9zZWQoKTogU3ViamVjdDx2b2lkPiB7XG4gICAgY29uc3QgcGFyZW50ID0gdGhpcy5wYXJlbnRNb2RhbDtcbiAgICByZXR1cm4gcGFyZW50ID8gcGFyZW50Ll9hZnRlckFsbENsb3NlZCA6IHRoaXMuYWZ0ZXJBbGxDbG9zZWRBdFRoaXNMZXZlbDtcbiAgfVxuXG4gIHJlYWRvbmx5IGFmdGVyQWxsQ2xvc2U6IE9ic2VydmFibGU8dm9pZD4gPSBkZWZlcigoKSA9PlxuICAgIHRoaXMub3Blbk1vZGFscy5sZW5ndGggPyB0aGlzLl9hZnRlckFsbENsb3NlZCA6IHRoaXMuX2FmdGVyQWxsQ2xvc2VkLnBpcGUoc3RhcnRXaXRoKHVuZGVmaW5lZCkpXG4gICkgYXMgT2JzZXJ2YWJsZTx2b2lkPjtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBvdmVybGF5OiBPdmVybGF5LFxuICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLFxuICAgIEBPcHRpb25hbCgpIEBTa2lwU2VsZigpIHByaXZhdGUgcGFyZW50TW9kYWw6IE1vZGFsTWFuYWdlclNlcnZpY2UsXG4gICAgcHJpdmF0ZSBjb21wb25lbnRGYWN0b3J5UmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcbiAgICBwcml2YXRlIGFwcFJlZjogQXBwbGljYXRpb25SZWYsXG4gICAgcHJpdmF0ZSBjb21tb25TZXJ2aWNlOiBDb21tb25TZXJ2aWNlXG4gICkge1xuICAgIHRoaXMuZmFjdG9yaWVzID0gdGhpcy5jb21wb25lbnRGYWN0b3J5UmVzb2x2ZXJbXCJfZmFjdG9yaWVzXCJdO1xuICAgIGlmICh0aGlzLmZhY3Rvcmllcykge1xuICAgICAgdGhpcy5mYWN0b3JpZXNBcnJheSA9IEFycmF5LmZyb20odGhpcy5mYWN0b3JpZXMpO1xuICAgIH1cbiAgfVxuXG4gIHJlYWRvbmx5IG1vZGFsQ29udGFpbmVyQ2xhc3M6IHN0cmluZyA9IFwic3Ntb2RhbF9jb250YWluZXJcIjtcblxuICBtb2RhbENvbnRhaW5lcjogRWxlbWVudDtcblxuICBwcml2YXRlIGNyZWF0ZU1vZGFsQ29udGFpbmVyKCkge1xuICAgIC8vIOWuueWZqFxuICAgIGxldCBjb250YWluZXIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHRoaXMubW9kYWxDb250YWluZXJDbGFzcyk7XG4gICAgaWYgKGNvbnRhaW5lciA9PSBudWxsKSB7XG4gICAgICBjb250YWluZXIgPSB3aW5kb3cuZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcbiAgICAgIGNvbnRhaW5lci5jbGFzc05hbWUgPSB0aGlzLm1vZGFsQ29udGFpbmVyQ2xhc3M7XG4gICAgICB3aW5kb3cuZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChjb250YWluZXIpO1xuICAgIH1cbiAgICB0aGlzLm1vZGFsQ29udGFpbmVyID0gY29udGFpbmVyO1xuICB9XG4gIC8qKlxuICAgKiBcbiAgICogQHBhcmFtIGNvbmZpZyBcbiAgICovXG4gIGNyZWF0ZTxULCBSID0gYW55Pihjb25maWc6IFNzTW9kYWxPcHRpb25zPFQsIFI+KTogU3NNb2RhbFJlZjxULCBSPiB7XG4gICAgcmV0dXJuIHRoaXMub3BlbjxULCBSPihjb25maWcuY29udGVudCBhcyBDb21wb25lbnRUeXBlPFQ+LCBjb25maWcpO1xuICB9XG4gIC8qKlxuICAgKiBcbiAgICovXG4gIGNsb3NlQWxsKCk6IHZvaWQge1xuICAgIHRoaXMuY2xvc2VNb2RhbHModGhpcy5vcGVuTW9kYWxzKTtcbiAgfVxuICBwcml2YXRlIGF0dGFjaE1vZGFsQ29udGFpbmVyMihvdmVybGF5UmVmOiBPdmVybGF5UmVmLCBjb25maWc6IFNzTW9kYWxPcHRpb25zKTogTW9kYWxDb250YWluZXJDb21wb25lbnQge1xuICAgIGNvbnN0IHVzZXJJbmplY3RvciA9IGNvbmZpZyAmJiBjb25maWcudmlld0NvbnRhaW5lclJlZiAmJiBjb25maWcudmlld0NvbnRhaW5lclJlZi5pbmplY3RvcjtcbiAgICBjb25zdCBpbmplY3RvciA9IG5ldyBQb3J0YWxJbmplY3RvcihcbiAgICAgIHVzZXJJbmplY3RvciB8fCB0aGlzLmluamVjdG9yLFxuICAgICAgbmV3IFdlYWtNYXA8YW55LCBhbnk+KFtcbiAgICAgICAgW092ZXJsYXlSZWYsIG92ZXJsYXlSZWZdLFxuICAgICAgICBbU3NNb2RhbE9wdGlvbnMsIGNvbmZpZ11cbiAgICAgIF0pXG4gICAgKTtcblxuICAgIGNvbnN0IENvbnRhaW5lckNvbXBvbmVudCA9IE1vZGFsQ29udGFpbmVyQ29tcG9uZW50O1xuXG4gICAgY29uc3QgY29udGFpbmVyUG9ydGFsID0gbmV3IENvbXBvbmVudFBvcnRhbDxNb2RhbENvbnRhaW5lckNvbXBvbmVudD4oQ29udGFpbmVyQ29tcG9uZW50LCBjb25maWcudmlld0NvbnRhaW5lclJlZiwgaW5qZWN0b3IpO1xuICAgIGNvbnN0IGNvbnRhaW5lclJlZiA9IG92ZXJsYXlSZWYuYXR0YWNoPE1vZGFsQ29udGFpbmVyQ29tcG9uZW50Pihjb250YWluZXJQb3J0YWwpO1xuXG4gICAgcmV0dXJuIGNvbnRhaW5lclJlZi5pbnN0YW5jZTtcbiAgfVxuICAvKipcbiAgICogXG4gICAqIEBwYXJhbSBjb21wb25lbnRPclRlbXBsYXRlUmVmIFxuICAgKiBAcGFyYW0gY29uZmlnIFxuICAgKi9cbiAgcHJpdmF0ZSBvcGVuPFQsIFI+KGNvbXBvbmVudE9yVGVtcGxhdGVSZWY6IENvbnRlbnRUeXBlPFQ+LCBjb25maWc/OiBTc01vZGFsT3B0aW9ucyk6IFNzTW9kYWxSZWY8VCwgUj4ge1xuICAgIGNvbnN0IGNvbmZpZ01lcmdlZCA9IGFwcGx5Q29uZmlnRGVmYXVsdHMoY29uZmlnIHx8IHt9LCBuZXcgU3NNb2RhbE9wdGlvbnMoKSk7XG4gICAgY29uc3QgbW9kYWxDb250YWluZXJSZWYgPSB0aGlzLmF0dGFjaE1vZGFsQ29udGFpbmVyKGNvbmZpZ01lcmdlZCk7XG4gICAgY29uc3QgbW9kYWxSZWYgPSB0aGlzLmF0dGFjaE1vZGFsQ29udGVudDxULCBSPihjb21wb25lbnRPclRlbXBsYXRlUmVmLCBjb25maWdNZXJnZWQsIG1vZGFsQ29udGFpbmVyUmVmKTtcbiAgICBtb2RhbENvbnRhaW5lclJlZi5pbnN0YW5jZS5tb2RhbFJlZiA9IG1vZGFsUmVmO1xuICAgIHRoaXMub3Blbk1vZGFscy5wdXNoKG1vZGFsUmVmKTtcbiAgICAvLyBjb25zdCBvdmVybGF5UmVmID0gdGhpcy5jcmVhdGVPdmVybGF5KGNvbmZpZ01lcmdlZCk7XG4gICAgLy8gY29uc3QgbW9kYWxDb250YWluZXIgPSB0aGlzLmF0dGFjaE1vZGFsQ29udGFpbmVyMihvdmVybGF5UmVmLCBjb25maWdNZXJnZWQpO1xuICAgIC8vIGNvbnN0IG1vZGFsUmVmID0gdGhpcy5hdHRhY2hNb2RhbENvbnRlbnQyPFQsIFI+KGNvbXBvbmVudE9yVGVtcGxhdGVSZWYsIG1vZGFsQ29udGFpbmVyLCBvdmVybGF5UmVmLCBjb25maWdNZXJnZWQpO1xuICAgIC8vIG1vZGFsQ29udGFpbmVyLm1vZGFsUmVmID0gbW9kYWxSZWY7XG4gICAgbW9kYWxSZWYuYWZ0ZXJDbG9zZS5zdWJzY3JpYmUoKCkgPT4gdGhpcy5yZW1vdmVPcGVuTW9kYWwobW9kYWxSZWYpKTtcbiAgICByZXR1cm4gbW9kYWxSZWY7XG4gIH1cbiAgLyoqXG4gICAqIFxuICAgKiBAcGFyYW0gbW9kYWxSZWYgXG4gICAqL1xuICBwcml2YXRlIHJlbW92ZU9wZW5Nb2RhbChtb2RhbFJlZjogU3NNb2RhbFJlZik6IHZvaWQge1xuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5vcGVuTW9kYWxzLmluZGV4T2YobW9kYWxSZWYpO1xuICAgIGlmIChpbmRleCA+IC0xKSB7XG4gICAgICB0aGlzLm9wZW5Nb2RhbHMuc3BsaWNlKGluZGV4LCAxKTtcblxuICAgICAgaWYgKCF0aGlzLm9wZW5Nb2RhbHMubGVuZ3RoKSB7XG4gICAgICAgIHRoaXMuX2FmdGVyQWxsQ2xvc2VkLm5leHQoKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgLyoqXG4gICAqIFxuICAgKiBAcGFyYW0gZGlhbG9ncyBcbiAgICovXG4gIHByaXZhdGUgY2xvc2VNb2RhbHMoZGlhbG9nczogU3NNb2RhbFJlZltdKTogdm9pZCB7XG4gICAgbGV0IGkgPSBkaWFsb2dzLmxlbmd0aDtcbiAgICB3aGlsZSAoaS0tKSB7XG4gICAgICBkaWFsb2dzW2ldLmNsb3NlKCk7XG4gICAgICBpZiAoIXRoaXMub3Blbk1vZGFscy5sZW5ndGgpIHtcbiAgICAgICAgdGhpcy5fYWZ0ZXJBbGxDbG9zZWQubmV4dCgpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICAvLyBwcml2YXRlIGNyZWF0ZU92ZXJsYXkoY29uZmlnOiBTc01vZGFsT3B0aW9ucyk6IE92ZXJsYXlSZWYge1xuICAvLyAgIGNvbnN0IG92ZXJsYXlDb25maWcgPSBuZXcgT3ZlcmxheUNvbmZpZyh7XG4gIC8vICAgICBoYXNCYWNrZHJvcDogdHJ1ZSxcbiAgLy8gICAgIHNjcm9sbFN0cmF0ZWd5OiB0aGlzLm92ZXJsYXkuc2Nyb2xsU3RyYXRlZ2llcy5ibG9jaygpLFxuICAvLyAgICAgcG9zaXRpb25TdHJhdGVneTogdGhpcy5vdmVybGF5LnBvc2l0aW9uKCkuZ2xvYmFsKCksXG4gIC8vICAgICBkaXNwb3NlT25OYXZpZ2F0aW9uOiBjb25maWcubnpDbG9zZU9uTmF2aWdhdGlvblxuICAvLyAgIH0pO1xuXG4gIC8vICAgaWYgKGNvbmZpZy5uek1hc2spIHtcbiAgLy8gICAgIG92ZXJsYXlDb25maWcuYmFja2Ryb3BDbGFzcyA9IFwiYW50LW1vZGFsLW1hc2tcIjtcbiAgLy8gICB9XG5cbiAgLy8gICByZXR1cm4gdGhpcy5vdmVybGF5LmNyZWF0ZShvdmVybGF5Q29uZmlnKTtcbiAgLy8gfVxuXG4gIC8vIHByaXZhdGUgYXR0YWNoTW9kYWxDb250ZW50MjxULCBSPihcbiAgLy8gICBjb21wb25lbnRPclRlbXBsYXRlUmVmOiBDb250ZW50VHlwZTxUPixcbiAgLy8gICBtb2RhbENvbnRhaW5lcjogTW9kYWxDb250YWluZXJDb21wb25lbnQsXG4gIC8vICAgb3ZlcmxheVJlZjogT3ZlcmxheVJlZixcbiAgLy8gICBjb25maWc6IFNzTW9kYWxPcHRpb25zPFQ+XG4gIC8vICk6IFNzTW9kYWxSZWY8VCwgUj4ge1xuICAvLyAgIGNvbnN0IG1vZGFsUmVmID0gbmV3IFNzTW9kYWxSZWY8VCwgUj4ob3ZlcmxheVJlZiwgY29uZmlnLCBtb2RhbENvbnRhaW5lcik7XG5cbiAgLy8gICBpZiAoY29tcG9uZW50T3JUZW1wbGF0ZVJlZiBpbnN0YW5jZW9mIFRlbXBsYXRlUmVmKSB7XG5cbiAgLy8gICB9IGVsc2UgaWYgKGNvbXBvbmVudE9yVGVtcGxhdGVSZWYhPW51bGwgJiYgdHlwZW9mIGNvbXBvbmVudE9yVGVtcGxhdGVSZWYgIT09ICdzdHJpbmcnKSB7XG4gIC8vICAgICBjb25zdCBpbmplY3RvciA9IHRoaXMuY3JlYXRlSW5qZWN0b3I8VCwgUj4obW9kYWxSZWYsIGNvbmZpZyk7XG4gIC8vICAgICBjb25zdCBjb250ZW50UmVmID0gbW9kYWxDb250YWluZXIuYXR0YWNoMjxUPihcbiAgLy8gICAgICAgbmV3IENvbXBvbmVudFBvcnRhbChjb21wb25lbnRPclRlbXBsYXRlUmVmLCBjb25maWcubnpWaWV3Q29udGFpbmVyUmVmLCBpbmplY3RvcilcbiAgLy8gICAgICk7XG4gIC8vICAgICBzZXRDb250ZW50SW5zdGFuY2VQYXJhbXM8VD4oY29udGVudFJlZi5pbnN0YW5jZSwgY29uZmlnLm56Q29tcG9uZW50UGFyYW1zKTtcbiAgLy8gICAgIG1vZGFsUmVmLmNvbXBvbmVudEluc3RhbmNlID0gY29udGVudFJlZi5pbnN0YW5jZTtcbiAgLy8gICB9XG4gIC8vICAgcmV0dXJuIG1vZGFsUmVmO1xuICAvLyB9XG4gIC8qKlxuICAgKiBcbiAgICogQHBhcmFtIGNvbmZpZyBcbiAgICovXG4gIHByaXZhdGUgYXR0YWNoTW9kYWxDb250YWluZXIoY29uZmlnOiBTc01vZGFsT3B0aW9ucyk6IENvbXBvbmVudFJlZjxNb2RhbENvbnRhaW5lckNvbXBvbmVudD4ge1xuICAgIGNvbnN0IHVzZXJJbmplY3RvciA9IGNvbmZpZyAmJiBjb25maWcudmlld0NvbnRhaW5lclJlZiAmJiBjb25maWcudmlld0NvbnRhaW5lclJlZi5pbmplY3RvcjtcbiAgICBjb25zdCBpbmplY3RvciA9IG5ldyBQb3J0YWxJbmplY3RvcihcbiAgICAgIHVzZXJJbmplY3RvciB8fCB0aGlzLmluamVjdG9yLFxuICAgICAgbmV3IFdlYWtNYXA8YW55LCBhbnk+KFtcbiAgICAgICAgW1NzTW9kYWxPcHRpb25zLCBjb25maWddXG4gICAgICBdKVxuICAgICk7XG4gICAgdGhpcy5jcmVhdGVNb2RhbENvbnRhaW5lcigpO1xuICAgIC8vIGNvbnN0IENvbnRhaW5lckNvbXBvbmVudCA9XG4gICAgLy8gICBjb25maWcubnpNb2RhbFR5cGUgPT09ICdjb25maXJtJ1xuICAgIC8vICAgICAgIE56TW9kYWxDb25maXJtQ29udGFpbmVyQ29tcG9uZW50OlxuICAgIC8vICAgICAgIE1vZGFsQ29udGFpbmVyQ29tcG9uZW50O1xuICAgIGxldCBpbnB1dHMgPSB7XG4gICAgICBjb25maWc6IGNvbmZpZ1xuICAgIH07XG4gICAgbGV0IGlucHV0UHJvdmlkZXJzID0gT2JqZWN0LmtleXMoaW5wdXRzKS5tYXAoKGlucHV0TmFtZSkgPT4ge1xuICAgICAgcmV0dXJuIHsgcHJvdmlkZTogaW5wdXROYW1lLCB1c2VWYWx1ZTogaW5wdXRzW2lucHV0TmFtZV0gfTtcbiAgICB9KTtcbiAgICBjb25zdCBDb250YWluZXJDb21wb25lbnQgPSBNb2RhbENvbnRhaW5lckNvbXBvbmVudDtcbiAgICBjb25zdCBmYWN0b3J5ID0gdGhpcy5jb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoQ29udGFpbmVyQ29tcG9uZW50KTtcbiAgICBjb25zdCBpbmplY3RvcmMgPSBJbmplY3Rvci5jcmVhdGUoeyBwcm92aWRlcnM6IGlucHV0UHJvdmlkZXJzLHBhcmVudDppbmplY3RvciB9KTtcbiAgICAvL2NvbnN0IGNvbnRhaW5lclJlZiA9IGZhY3RvcnkuY3JlYXRlKFJlZmxlY3RpdmVJbmplY3Rvci5yZXNvbHZlQW5kQ3JlYXRlKGlucHV0UHJvdmlkZXJzLCBpbmplY3RvcikpO1xuICAgIGNvbnN0IGNvbnRhaW5lclJlZiA9IGZhY3RvcnkuY3JlYXRlKGluamVjdG9yYyk7XG4gICAgdGhpcy5tb2RhbENvbnRhaW5lci5hcHBlbmRDaGlsZCh0aGlzLmNvbW1vblNlcnZpY2UuZ2V0Q29tcG9uZW50Um9vdE5vZGUoY29udGFpbmVyUmVmKSk7XG4gICAgLy8g5Yqg5YWlYW5ndWxhcuiEj+ajgOafpVxuICAgIHRoaXMuYXBwUmVmLmF0dGFjaFZpZXcoY29udGFpbmVyUmVmLmhvc3RWaWV3KTtcbiAgICByZXR1cm4gY29udGFpbmVyUmVmO1xuICB9XG5cbiAgZmluZENvbXBvbmVudChuYW1lOiBzdHJpbmcpOiBUeXBlPGFueT4ge1xuICAgIGxldCBjb21wID0gbnVsbDtcbiAgICBpZiAodGhpcy5mYWN0b3JpZXMpIHtcbiAgICAgIGlmICghdGhpcy5mYWN0b3JpZXMgfHwgdGhpcy5mYWN0b3JpZXMuc2l6ZSA8PSAwKSByZXR1cm4gbnVsbDtcbiAgICAgIGxldCBpdGVtID0gdGhpcy5mYWN0b3JpZXNBcnJheS5maW5kKCh2YWx1ZSwgaW5kZXg6IG51bWJlciwgYXJyKSA9PiB7XG4gICAgICAgIHJldHVybiB2YWx1ZVsxXS5zZWxlY3Rvci50b0xvd2VyQ2FzZSgpID09PSBuYW1lLnRvTG93ZXJDYXNlKCkgfHwgdmFsdWVbMF0ubmFtZS50b0xvd2VyQ2FzZSgpID09PSBuYW1lLnRvTG9jYWxlTG93ZXJDYXNlKCk7XG4gICAgICB9KTtcbiAgICAgIGlmIChpdGVtKSB7XG4gICAgICAgIGNvbXAgPSBpdGVtWzBdO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAvL25nOeWPiuS7peS4ilxuICAgICAgY29uc3QgY29tcEluZm8gPSBmaW5kQ29tcG9uZW50SW5mbyhuYW1lKTtcbiAgICAgIGlmIChjb21wSW5mbykge1xuICAgICAgICByZXR1cm4gY29tcEluZm8uY29tcG9uZW50O1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gY29tcDtcblxuICB9XG4gIC8qKlxuICAgKiBcbiAgICogQHBhcmFtIGNvbXBvbmVudE9yVGVtcGxhdGVSZWYgXG4gICAqIEBwYXJhbSBjb25maWcgXG4gICAqIEBwYXJhbSBtb2RhbENvbnRhaW5lclxuICAgKi9cbiAgcHJpdmF0ZSBhdHRhY2hNb2RhbENvbnRlbnQ8VCwgUj4oXG4gICAgY29tcG9uZW50T3JUZW1wbGF0ZVJlZjogQ29udGVudFR5cGU8VD4sXG4gICAgY29uZmlnOiBTc01vZGFsT3B0aW9uczxUPixcbiAgICBtb2RhbENvbnRhaW5lclJlZjogQ29tcG9uZW50UmVmPE1vZGFsQ29udGFpbmVyQ29tcG9uZW50PixcbiAgKTogU3NNb2RhbFJlZjxULCBSPiB7XG4gICAgY29uc3QgbW9kYWxSZWYgPSBuZXcgU3NNb2RhbFJlZjxULCBSPihjb25maWcsIG1vZGFsQ29udGFpbmVyUmVmKTtcblxuICAgIGlmIChjb21wb25lbnRPclRlbXBsYXRlUmVmIGluc3RhbmNlb2YgVGVtcGxhdGVSZWYpIHtcbiAgICAgIC8vIFRPRE8gXG5cbiAgICB9IGVsc2UgaWYgKGNvbXBvbmVudE9yVGVtcGxhdGVSZWYgJiYgdHlwZW9mIGNvbXBvbmVudE9yVGVtcGxhdGVSZWYgIT09ICdzdHJpbmcnKSB7XG4gICAgICBsZXQgaW5wdXRzID0ge307XG4gICAgICBpZiAoY29uZmlnLmNvbXBvbmVudFBhcmFtcykge1xuICAgICAgICBpbnB1dHMgPSBjb25maWcuY29tcG9uZW50UGFyYW1zO1xuICAgICAgfVxuICAgICAgbGV0IGlucHV0UHJvdmlkZXJzID0gT2JqZWN0LmtleXMoaW5wdXRzKS5tYXAoKGlucHV0TmFtZSkgPT4ge1xuICAgICAgICByZXR1cm4geyBwcm92aWRlOiBpbnB1dE5hbWUsIHVzZVZhbHVlOiBpbnB1dHNbaW5wdXROYW1lXSB9O1xuICAgICAgfSk7XG4gICAgICBsZXQgY29tcG9uZW50ID0gY29tcG9uZW50T3JUZW1wbGF0ZVJlZjtcbiAgICAgIGlmICh0aGlzLmZhY3RvcmllcyAmJiAhdGhpcy5mYWN0b3JpZXMuZ2V0KGNvbXBvbmVudE9yVGVtcGxhdGVSZWYpKSB7XG4gICAgICAgIGNvbXBvbmVudCA9IHRoaXMuZmluZENvbXBvbmVudChjb21wb25lbnRPclRlbXBsYXRlUmVmLm5hbWUpO1xuICAgICAgfVxuICAgICAgY29uc3QgZmFjdG9yeSA9IHRoaXMuY29tcG9uZW50RmFjdG9yeVJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KGNvbXBvbmVudCk7XG4gICAgICBjb25zdCBpbmplY3RvciA9IEluamVjdG9yLmNyZWF0ZSh7IHByb3ZpZGVyczogaW5wdXRQcm92aWRlcnMsIHBhcmVudDogdGhpcy5jcmVhdGVJbmplY3Rvcihtb2RhbFJlZiwgY29uZmlnKSB9KTtcbiAgICAgIC8vIGNvbnN0IGNvbXBSZWYgPSBmYWN0b3J5LmNyZWF0ZShSZWZsZWN0aXZlSW5qZWN0b3IucmVzb2x2ZUFuZENyZWF0ZShpbnB1dFByb3ZpZGVycywgdGhpcy5jcmVhdGVJbmplY3Rvcihtb2RhbFJlZiwgY29uZmlnKSkpO1xuICAgICAgY29uc3QgY29tcFJlZiA9IGZhY3RvcnkuY3JlYXRlKGluamVjdG9yKTtcbiAgICAgIHNldENvbnRlbnRJbnN0YW5jZVBhcmFtczxUPihjb21wUmVmLmluc3RhbmNlLCBjb25maWcuY29tcG9uZW50UGFyYW1zKTtcbiAgICAgIG1vZGFsQ29udGFpbmVyUmVmLmluc3RhbmNlLmF0dGFjaENvbXBvbmVudFBvcnRhbDxUPihjb21wUmVmKTtcbiAgICAgIG1vZGFsUmVmLmNvbXBvbmVudEluc3RhbmNlID0gY29tcFJlZi5pbnN0YW5jZTtcbiAgICAgIG1vZGFsUmVmLmNvbXBvbmVudFJlZiA9IGNvbXBSZWY7XG4gICAgfVxuICAgIHJldHVybiBtb2RhbFJlZjtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlSW5qZWN0b3I8VCwgUj4obW9kYWxSZWY6IFNzTW9kYWxSZWY8VCwgUj4sIGNvbmZpZzogU3NNb2RhbE9wdGlvbnM8VD4pOiBQb3J0YWxJbmplY3RvciB7XG4gICAgY29uc3QgdXNlckluamVjdG9yID0gY29uZmlnICYmIGNvbmZpZy52aWV3Q29udGFpbmVyUmVmICYmIGNvbmZpZy52aWV3Q29udGFpbmVyUmVmLmluamVjdG9yO1xuICAgIGNvbnN0IGluamVjdGlvblRva2VucyA9IG5ldyBXZWFrTWFwPGFueSwgYW55PihbW1NzTW9kYWxSZWYsIG1vZGFsUmVmXV0pO1xuXG4gICAgcmV0dXJuIG5ldyBQb3J0YWxJbmplY3Rvcih1c2VySW5qZWN0b3IgfHwgdGhpcy5pbmplY3RvciwgaW5qZWN0aW9uVG9rZW5zKTtcbiAgfVxuXG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5jbG9zZU1vZGFscyh0aGlzLm9wZW5Nb2RhbHNBdFRoaXNMZXZlbCk7XG4gICAgdGhpcy5hZnRlckFsbENsb3NlZEF0VGhpc0xldmVsLmNvbXBsZXRlKCk7XG4gIH1cbn0iXX0=