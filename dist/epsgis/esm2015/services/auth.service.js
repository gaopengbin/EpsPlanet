import { Injectable } from '@angular/core';
import * as i0 from "@angular/core";
import * as i1 from "./request.service";
export class AuthService {
    constructor(req) {
        this.req = req;
        this._tokenKey = "";
        this._userKey = "__current_user";
        this._currentUser = null;
        this._tokenKey = this.req.getTokenKey();
    }
    saveInfo2Local(key, data) {
        if (window.sessionStorage) {
            sessionStorage.setItem(key, JSON.stringify(data));
        }
        else {
            console.log("浏览器不支持sessionStorage");
        }
    }
    getInfoFromLocal(key) {
        if (window.sessionStorage) {
            return sessionStorage.getItem(key);
        }
        else {
            console.log("浏览器不支持sessionStorage");
        }
        return "";
    }
    saveToken(data) {
        this.saveInfo2Local(this._tokenKey, data);
        this.req.setAccessToken(data.access_token);
    }
    getLocalToken() {
        let str = this.getInfoFromLocal(this._tokenKey);
        if (str != "") {
            return JSON.parse(str);
        }
        return null;
    }
    refreshToken(refresh_token) {
        return new Promise((resolve, reject) => {
            this.req.get('epsoffice/token/refresh', { "refresh_token": refresh_token }).then(result => {
                if (result.success) {
                    this.saveToken(result.data);
                }
                resolve(result);
            }).catch(err => reject(err));
        });
    }
    userLogin(username, password) {
        return new Promise((resolve, reject) => {
            this.req.post("epsoffice/user/login", { "username": username, "password": password })
                .then(result => {
                if (result.success) {
                    this._currentUser = result.data;
                    this.saveInfo2Local(this._userKey, result.data);
                    this.saveToken(result.data.token);
                }
                resolve(result);
            }).catch(reject);
        });
    }
    checkLogin() {
        return this.req.get("epsoffice/user/login/validate");
    }
    logout() {
        return new Promise((resove, reject) => {
            this.req.post("epsoffice/user/logout").then(result => {
                if (result.success) {
                    this.removeToken();
                }
                resove(result.success);
            }).catch(err => {
                console.error(err);
                resove(false);
            });
        });
    }
    removeToken() {
        this._currentUser = null;
        this.req.setAccessToken("");
        sessionStorage.removeItem(this._tokenKey);
        sessionStorage.removeItem(this._userKey);
    }
    getRemoteUser() {
        return new Promise((resolve, reject) => {
            this.req.get("epsoffice/user/login/info").then(result => {
                if (result.success) {
                    this._currentUser = result.data;
                    this.saveInfo2Local(this._userKey, result.data);
                    this._currentUser.token = this.getLocalToken();
                    resolve(result.data);
                }
                else {
                    console.error(result.msg);
                    resolve(null);
                }
            }).catch(err => {
                console.error(err);
                resolve(null);
            });
        });
    }
    getCurrentUser() {
        if (this._currentUser) {
            return this._currentUser;
        }
        const str = this.getInfoFromLocal(this._userKey);
        if (str) {
            const _user = JSON.parse(str);
            this._currentUser = _user;
            this._currentUser.token = this.getLocalToken();
        }
        return this._currentUser;
    }
}
AuthService.ɵfac = function AuthService_Factory(t) { return new (t || AuthService)(i0.ɵɵinject(i1.HttpReqService)); };
AuthService.ɵprov = i0.ɵɵdefineInjectable({ token: AuthService, factory: AuthService.ɵfac, providedIn: 'root' });
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(AuthService, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: i1.HttpReqService }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvZXBzZ2lzL3NlcnZpY2VzL2F1dGguc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDOzs7QUFTM0MsTUFBTSxPQUFPLFdBQVc7SUFJcEIsWUFBb0IsR0FBbUI7UUFBbkIsUUFBRyxHQUFILEdBQUcsQ0FBZ0I7UUFIL0IsY0FBUyxHQUFHLEVBQUUsQ0FBQztRQUNmLGFBQVEsR0FBRyxnQkFBZ0IsQ0FBQztRQUM1QixpQkFBWSxHQUFxQixJQUFJLENBQUM7UUFFMUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQzVDLENBQUM7SUFNTyxjQUFjLENBQUMsR0FBVyxFQUFFLElBQVM7UUFDekMsSUFBSSxNQUFNLENBQUMsY0FBYyxFQUFFO1lBQ3ZCLGNBQWMsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztTQUNyRDthQUFNO1lBQ0gsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO1NBQ3ZDO0lBQ0wsQ0FBQztJQUtPLGdCQUFnQixDQUFDLEdBQVc7UUFDaEMsSUFBSSxNQUFNLENBQUMsY0FBYyxFQUFFO1lBQ3ZCLE9BQU8sY0FBYyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUN0QzthQUFNO1lBQ0gsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO1NBQ3ZDO1FBQ0QsT0FBTyxFQUFFLENBQUM7SUFDZCxDQUFDO0lBS08sU0FBUyxDQUFDLElBQWdCO1FBQzlCLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUMxQyxJQUFJLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUlELGFBQWE7UUFDVCxJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ2hELElBQUksR0FBRyxJQUFJLEVBQUUsRUFBRTtZQUNYLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUMxQjtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFJRCxZQUFZLENBQUMsYUFBcUI7UUFDOUIsT0FBTyxJQUFJLE9BQU8sQ0FBcUIsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDdkQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMseUJBQXlCLEVBQUUsRUFBRSxlQUFlLEVBQUUsYUFBYSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUU7Z0JBQ3RGLElBQUksTUFBTSxDQUFDLE9BQU8sRUFBRTtvQkFDaEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7aUJBQy9CO2dCQUNELE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNwQixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNqQyxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFNRCxTQUFTLENBQUMsUUFBZ0IsRUFBRSxRQUFnQjtRQUN4QyxPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ25DLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLHNCQUFzQixFQUFFLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLENBQUM7aUJBQ2hGLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRTtnQkFDWCxJQUFJLE1BQU0sQ0FBQyxPQUFPLEVBQUU7b0JBQ2hCLElBQUksQ0FBQyxZQUFZLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztvQkFDaEMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDaEQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO2lCQUNyQztnQkFDRCxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDcEIsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3pCLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUtELFVBQVU7UUFDTixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLCtCQUErQixDQUFDLENBQUM7SUFDekQsQ0FBQztJQUlELE1BQU07UUFDRixPQUFPLElBQUksT0FBTyxDQUFVLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQzNDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFO2dCQUNqRCxJQUFJLE1BQU0sQ0FBQyxPQUFPLEVBQUU7b0JBQ2hCLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztpQkFDdEI7Z0JBQ0QsTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUMzQixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUU7Z0JBQ1gsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDbkIsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ2xCLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBQ0QsV0FBVztRQUNQLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzVCLGNBQWMsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzFDLGNBQWMsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQzdDLENBQUM7SUFJRCxhQUFhO1FBQ1QsT0FBTyxJQUFJLE9BQU8sQ0FBbUIsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDckQsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsMkJBQTJCLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUU7Z0JBQ3BELElBQUksTUFBTSxDQUFDLE9BQU8sRUFBRTtvQkFDaEIsSUFBSSxDQUFDLFlBQVksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDO29CQUNoQyxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUNoRCxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7b0JBQy9DLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7aUJBQ3hCO3FCQUFNO29CQUNILE9BQU8sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO29CQUMxQixPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7aUJBQ2pCO1lBQ0wsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFO2dCQUNYLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ25CLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNsQixDQUFDLENBQUMsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUlELGNBQWM7UUFDVixJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDbkIsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDO1NBQzVCO1FBQ0QsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNqRCxJQUFJLEdBQUcsRUFBRTtZQUNMLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDOUIsSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUM7WUFDMUIsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1NBQ2xEO1FBQ0QsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDO0lBQzdCLENBQUM7O3NFQWhKUSxXQUFXO21EQUFYLFdBQVcsV0FBWCxXQUFXLG1CQUZSLE1BQU07dUZBRVQsV0FBVztjQUh2QixVQUFVO2VBQUM7Z0JBQ1IsVUFBVSxFQUFFLE1BQU07YUFDckIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBIdHRwUmVxU2VydmljZSwgT2JqZWN0UGFyYSB9IGZyb20gJy4vcmVxdWVzdC5zZXJ2aWNlJztcbmltcG9ydCB7IFRva2VuTW9kZWwsIFJlcXVlc3RSZXN1bHRNb2RlbCwgQ3VycmVudExvZ2luVXNlciB9IGZyb20gJy4uL21vZGVscy9odHRwL3JlcXVlc3QucmVzdWx0Jztcbi8qKlxuICogY3JlYXRlIGJ5IHJ1aXIgMjAyMDAyMjRcbiAqL1xuQEluamVjdGFibGUoe1xuICAgIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBBdXRoU2VydmljZSB7XG4gICAgcHJpdmF0ZSBfdG9rZW5LZXkgPSBcIlwiO1xuICAgIHByaXZhdGUgX3VzZXJLZXkgPSBcIl9fY3VycmVudF91c2VyXCI7XG4gICAgcHJpdmF0ZSBfY3VycmVudFVzZXI6IEN1cnJlbnRMb2dpblVzZXIgPSBudWxsO1xuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVxOiBIdHRwUmVxU2VydmljZSkge1xuICAgICAgICB0aGlzLl90b2tlbktleSA9IHRoaXMucmVxLmdldFRva2VuS2V5KCk7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIFxuICAgICAqIEBwYXJhbSBrZXkgXG4gICAgICogQHBhcmFtIGRhdGEgXG4gICAgICovXG4gICAgcHJpdmF0ZSBzYXZlSW5mbzJMb2NhbChrZXk6IHN0cmluZywgZGF0YTogYW55KSB7XG4gICAgICAgIGlmICh3aW5kb3cuc2Vzc2lvblN0b3JhZ2UpIHsvL2xvY2FsU3RvcmFnZVxuICAgICAgICAgICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShrZXksIEpTT04uc3RyaW5naWZ5KGRhdGEpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwi5rWP6KeI5Zmo5LiN5pSv5oyBc2Vzc2lvblN0b3JhZ2VcIik7XG4gICAgICAgIH1cbiAgICB9XG4gICAgLyoqXG4gICAgICogXG4gICAgICogQHBhcmFtIGtleSBcbiAgICAgKi9cbiAgICBwcml2YXRlIGdldEluZm9Gcm9tTG9jYWwoa2V5OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICBpZiAod2luZG93LnNlc3Npb25TdG9yYWdlKSB7XG4gICAgICAgICAgICByZXR1cm4gc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShrZXkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCLmtY/op4jlmajkuI3mlK/mjIFzZXNzaW9uU3RvcmFnZVwiKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gXCJcIjtcbiAgICB9XG4gICAgLyoqXG4gICAgICogXG4gICAgICogQHBhcmFtIGRhdGEgXG4gICAgICovXG4gICAgcHJpdmF0ZSBzYXZlVG9rZW4oZGF0YTogVG9rZW5Nb2RlbCkge1xuICAgICAgICB0aGlzLnNhdmVJbmZvMkxvY2FsKHRoaXMuX3Rva2VuS2V5LCBkYXRhKTtcbiAgICAgICAgdGhpcy5yZXEuc2V0QWNjZXNzVG9rZW4oZGF0YS5hY2Nlc3NfdG9rZW4pO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiDojrflj5bmnKzlnLDkv53lrZjnmoR0b2tlblxuICAgICAqL1xuICAgIGdldExvY2FsVG9rZW4oKTogVG9rZW5Nb2RlbCB7XG4gICAgICAgIGxldCBzdHIgPSB0aGlzLmdldEluZm9Gcm9tTG9jYWwodGhpcy5fdG9rZW5LZXkpO1xuICAgICAgICBpZiAoc3RyICE9IFwiXCIpIHtcbiAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKHN0cik7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIOWIt+aWsHRva2VuXG4gICAgICovXG4gICAgcmVmcmVzaFRva2VuKHJlZnJlc2hfdG9rZW46IHN0cmluZyk6IFByb21pc2U8UmVxdWVzdFJlc3VsdE1vZGVsPiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxSZXF1ZXN0UmVzdWx0TW9kZWw+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRoaXMucmVxLmdldCgnZXBzb2ZmaWNlL3Rva2VuL3JlZnJlc2gnLCB7IFwicmVmcmVzaF90b2tlblwiOiByZWZyZXNoX3Rva2VuIH0pLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgICAgICAgICBpZiAocmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zYXZlVG9rZW4ocmVzdWx0LmRhdGEpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgICAgICB9KS5jYXRjaChlcnIgPT4gcmVqZWN0KGVycikpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgLyoqXG4gICAgICog55m75b2VXG4gICAgICogQHBhcmFtIHVzZXJuYW1lIFxuICAgICAqIEBwYXJhbSBwYXNzd29yZCBcbiAgICAgKi9cbiAgICB1c2VyTG9naW4odXNlcm5hbWU6IHN0cmluZywgcGFzc3dvcmQ6IHN0cmluZyk6IFByb21pc2U8UmVxdWVzdFJlc3VsdE1vZGVsPiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICB0aGlzLnJlcS5wb3N0KFwiZXBzb2ZmaWNlL3VzZXIvbG9naW5cIiwgeyBcInVzZXJuYW1lXCI6IHVzZXJuYW1lLCBcInBhc3N3b3JkXCI6IHBhc3N3b3JkIH0pXG4gICAgICAgICAgICAgICAgLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdC5zdWNjZXNzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50VXNlciA9IHJlc3VsdC5kYXRhO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zYXZlSW5mbzJMb2NhbCh0aGlzLl91c2VyS2V5LCByZXN1bHQuZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNhdmVUb2tlbihyZXN1bHQuZGF0YS50b2tlbik7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xuICAgICAgICAgICAgICAgIH0pLmNhdGNoKHJlamVjdCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOmqjOivgXRva2VuXG4gICAgICovXG4gICAgY2hlY2tMb2dpbigpOiBQcm9taXNlPFJlcXVlc3RSZXN1bHRNb2RlbD4ge1xuICAgICAgICByZXR1cm4gdGhpcy5yZXEuZ2V0KFwiZXBzb2ZmaWNlL3VzZXIvbG9naW4vdmFsaWRhdGVcIik7XG4gICAgfVxuICAgIC8qKlxuICAgICAqIFxuICAgICAqL1xuICAgIGxvZ291dCgpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPGJvb2xlYW4+KChyZXNvdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5yZXEucG9zdChcImVwc29mZmljZS91c2VyL2xvZ291dFwiKS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdC5zdWNjZXNzKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlVG9rZW4oKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmVzb3ZlKHJlc3VsdC5zdWNjZXNzKTtcbiAgICAgICAgICAgIH0pLmNhdGNoKGVyciA9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlcnIpO1xuICAgICAgICAgICAgICAgIHJlc292ZShmYWxzZSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHJlbW92ZVRva2VuKCkge1xuICAgICAgICB0aGlzLl9jdXJyZW50VXNlciA9IG51bGw7XG4gICAgICAgIHRoaXMucmVxLnNldEFjY2Vzc1Rva2VuKFwiXCIpO1xuICAgICAgICBzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKHRoaXMuX3Rva2VuS2V5KTtcbiAgICAgICAgc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbSh0aGlzLl91c2VyS2V5KTtcbiAgICB9XG4gICAgLyoqXG4gICAgICog6L+c56iL6I635Y+W55So5oi35L+h5oGvXG4gICAgICovXG4gICAgZ2V0UmVtb3RlVXNlcigpOiBQcm9taXNlPEN1cnJlbnRMb2dpblVzZXI+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPEN1cnJlbnRMb2dpblVzZXI+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIHRoaXMucmVxLmdldChcImVwc29mZmljZS91c2VyL2xvZ2luL2luZm9cIikudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChyZXN1bHQuc3VjY2Vzcykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9jdXJyZW50VXNlciA9IHJlc3VsdC5kYXRhO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNhdmVJbmZvMkxvY2FsKHRoaXMuX3VzZXJLZXksIHJlc3VsdC5kYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fY3VycmVudFVzZXIudG9rZW4gPSB0aGlzLmdldExvY2FsVG9rZW4oKTtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHQuZGF0YSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihyZXN1bHQubXNnKTtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShudWxsKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KS5jYXRjaChlcnIgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcbiAgICAgICAgICAgICAgICByZXNvbHZlKG51bGwpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICAvKipcbiAgICAgKiDojrflj5blvZPliY3nlKjmiLfkv6Hmga9cbiAgICAgKi9cbiAgICBnZXRDdXJyZW50VXNlcigpOiBDdXJyZW50TG9naW5Vc2VyIHtcbiAgICAgICAgaWYgKHRoaXMuX2N1cnJlbnRVc2VyKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fY3VycmVudFVzZXI7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgc3RyID0gdGhpcy5nZXRJbmZvRnJvbUxvY2FsKHRoaXMuX3VzZXJLZXkpO1xuICAgICAgICBpZiAoc3RyKSB7XG4gICAgICAgICAgICBjb25zdCBfdXNlciA9IEpTT04ucGFyc2Uoc3RyKTtcbiAgICAgICAgICAgIHRoaXMuX2N1cnJlbnRVc2VyID0gX3VzZXI7XG4gICAgICAgICAgICB0aGlzLl9jdXJyZW50VXNlci50b2tlbiA9IHRoaXMuZ2V0TG9jYWxUb2tlbigpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLl9jdXJyZW50VXNlcjtcbiAgICB9XG59XG4iXX0=